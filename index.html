<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"/>
    <title>æˆ‘çš„è´¢åŠ¡æŠ¥è¡¨ Pro - å¹´åº¦å‡çº§ç‰ˆï¼ˆä¼˜åŒ– Safari æ€§èƒ½ç‰ˆï¼‰</title>

    <!-- Tailwind & Chart.js & FontAwesome (ä¿ç•™ CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root{
            --ios-curve: cubic-bezier(0.25, 0.8, 0.25, 1);
            --ios-spring: cubic-bezier(0.175, 0.885, 0.32, 1.1);
        }

        /* ---------- åŸºç¡€ä¸ iOS / Safari å…¼å®¹ ---------- */
        html,body{height:100%;min-height:100vh;background:#F2F2F7;-webkit-font-smoothing:antialiased;margin:0;font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",Helvetica,Arial,sans-serif;color:#1C1C1E;}
        *{box-sizing:border-box}
        ::-webkit-scrollbar{display:none}
        body{-webkit-tap-highlight-color:transparent;padding-bottom:env(safe-area-inset-bottom);-webkit-overflow-scrolling:touch;}

        /* ç¦æ­¢å¤§é¢ç§¯æ–‡æœ¬é€‰ä¸­ï¼Œè¾“å…¥æ¡†ä»å¯é€‰ä¸­ */
        *{ -webkit-user-select:none; user-select:none; -webkit-touch-callout:none; }
        input, textarea, select { -webkit-user-select:auto; user-select:auto; }

        /* ---------- è§†è§‰æ ·å¼ (å°½é‡åªä½¿ç”¨ transform/opacity åŠ¨ç”») ---------- */
        .glass-nav { position:fixed; top:0; left:0; right:0; z-index:50; background:#F2F2F7; padding-top:calc(env(safe-area-inset-top) + 8px); padding-bottom:12px; transition:background 0.25s ease; -webkit-backdrop-filter: blur(8px); backdrop-filter: blur(8px); }
        #main-content{ padding-top: calc(env(safe-area-inset-top) + 90px); padding-left:16px; padding-right:16px; padding-bottom:96px; }

        .ios-card, .ios-clickable { background:#fff; border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,0.04); transition: transform 0.25s var(--ios-curve), opacity 0.18s; will-change: transform, opacity; }
        .ios-card:active, .ios-clickable:active{ transform: translateZ(0) scale(0.98); }

        .ios-card-static{ background:#fff; border-radius:16px; box-shadow:0 1px 3px rgba(0,0,0,0.03); overflow:hidden; }

        .btn-ios{ transition: transform 0.18s, background-color 0.18s; }
        .btn-ios:active{ transform: translateZ(0) scale(0.97); }

        .modal-overlay{ opacity:0; transition: opacity 0.32s var(--ios-curve); background: rgba(0,0,0,0.28); -webkit-backdrop-filter: blur(4px); backdrop-filter: blur(4px); }
        .modal-enter .modal-overlay{ opacity:1; }

        .modal-content{ transform: translateY(100%); transition: transform 0.42s var(--ios-spring); will-change: transform; }
        .modal-enter .modal-content{ transform: translateY(0); }

        /* åˆ—è¡¨é¡¹åŠ¨ç”»ï¼šåªæ“çºµ transform/opacity */
        .list-item-anim{ opacity:0; transform: translateY(10px) scale(0.995); will-change: transform, opacity; transition: transform 0.45s var(--ios-curve), opacity 0.45s var(--ios-curve); }
        .list-item-anim.in{ opacity:1; transform: translateY(0) scale(1); }

        /* è¿›åº¦æ¡ï¼ˆåªæ”¹å®½åº¦ï¼‰ */
        .sub-progress-bg{ background:#E5E5EA; border-radius:4px; height:6px; overflow:hidden; }
        .sub-progress-fill{ height:100%; border-radius:4px; width:0%; transition: width 0.9s var(--ios-curve); will-change: width; }

        .rank-bar-bg{ background:#f3f4f6; height:6px; border-radius:3px; width:100%; overflow:hidden; margin-top:6px; }
        .rank-bar-fill{ height:100%; border-radius:3px; width:0%; transition: width 0.8s ease-out; will-change: width; }

        /* æµ®åŠ¨å¹´ä»½é€‰æ‹©å™¨ */
        .floating-year-selector{ position:fixed; bottom: calc(env(safe-area-inset-bottom) + 30px); left:50%; transform:translateX(-50%); z-index:70; background:rgba(255,255,255,0.95); -webkit-backdrop-filter: blur(8px); backdrop-filter: blur(8px); border-radius:999px; padding:4px; border:1px solid rgba(0,0,0,0.05); box-shadow:0 6px 18px rgba(0,0,0,0.08); }

        /* æ— éšœç¢ï¼šå‡å°‘åŠ¨ç”» */
        @media (prefers-reduced-motion: reduce) {
            .list-item-anim, .modal-content, .modal-overlay, .sub-progress-fill, .rank-bar-fill { transition-duration: 0.01ms !important; animation: none !important; }
        }

        /* å°å±å¸ƒå±€å®¹é”™ */
        @media (max-width:420px){ .text-3xl{ font-size:1.4rem } }
    </style>
</head>
<body class="antialiased">

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="glass-nav">
        <div class="px-5 flex justify-between items-center">
            <div class="date-trigger-wrapper btn-ios">
                <div class="flex items-center gap-2 py-1">
                    <h1 id="current-date" class="text-3xl font-bold tracking-tight text-black leading-none">...</h1>
                </div>
                <input id="native-month-input" type="month" class="native-date-input" aria-label="é€‰æ‹©æœˆä»½">
            </div>

            <button id="btn-annual" class="h-9 px-4 bg-blue-500/10 text-blue-600 rounded-full flex items-center gap-1.5 text-xs font-bold">
                <i class="fas fa-chart-pie"></i> å¹´æŠ¥
            </button>
        </div>
    </div>

    <!-- ä¸»å†…å®¹ -->
    <div id="main-content">
        <!-- æœ¬æœˆç»“ä½™ -->
        <section>
            <div class="ios-card p-5 flex justify-between items-center relative overflow-hidden">
                <div class="z-10">
                    <p class="text-sm font-medium text-gray-500 mb-1">æœ¬æœˆç»“ä½™ (Cash Flow)</p>
                    <p class="text-4xl font-bold text-black tracking-tight" id="cash-flow-display">Â¥0.00</p>
                </div>
                <div class="relative bg-blue-50 h-12 w-12 rounded-full flex items-center justify-center text-blue-500 shadow-sm z-20">
                    <i class="far fa-calendar-alt text-lg"></i>
                    <input id="mini-month-input" type="month" class="native-date-input rounded-full" aria-label="åˆ‡æ¢æœˆä»½">
                </div>
                <div class="absolute -right-6 -bottom-6 h-32 w-32 bg-blue-400/20 opacity-40 rounded-full blur-2xl pointer-events-none"></div>
            </div>
        </section>

        <!-- æ”¶æ”¯åˆ†æ -->
        <section class="mt-5">
            <h2 class="text-xs font-semibold text-gray-400 uppercase tracking-wider ml-1 mb-2">æ”¶æ”¯åˆ†æ</h2>
            <div class="ios-card-static p-0 overflow-hidden">
                <div class="grid grid-cols-2 divide-x divide-gray-100 border-b border-gray-100/50">
                    <div id="block-income" class="p-4 cursor-pointer">
                        <div class="flex items-center gap-1 mb-2">
                            <div class="w-2 h-2 rounded-full bg-green-500"></div>
                            <span class="text-xs font-medium text-gray-500">æ€»æ”¶å…¥</span>
                        </div>
                        <p id="total-income" class="text-xl font-bold text-black">Â¥0</p>
                    </div>
                    <div id="block-expense" class="p-4 cursor-pointer">
                        <div class="flex items-center gap-1 mb-2">
                            <div class="w-2 h-2 rounded-full bg-red-500"></div>
                            <span class="text-xs font-medium text-gray-500">æ€»æ”¯å‡º</span>
                        </div>
                        <p id="total-expense" class="text-xl font-bold text-black">Â¥0</p>
                    </div>
                </div>

                <div class="p-6 flex flex-col items-center justify-center relative border-b border-gray-100/50">
                    <div class="h-48 w-full relative z-10">
                        <canvas id="expenseChart"></canvas>
                    </div>
                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none mt-2">
                        <span class="text-xs text-gray-400 font-medium">æ”¯å‡ºåˆ†å¸ƒ</span>
                    </div>
                </div>

                <div id="expense-legend" class="p-4 space-y-4"></div>

                <div class="p-4 border-t border-gray-100/50">
                    <button id="btn-add-transaction" class="w-full bg-[#007AFF] text-white py-3.5 rounded-xl font-semibold text-[17px] shadow-lg">è®°ä¸€ç¬”</button>
                </div>
            </div>
        </section>

        <!-- èµ„äº§ç®¡ç† -->
        <section class="mt-5">
            <h2 class="text-xs font-semibold text-gray-400 uppercase tracking-wider ml-1 mb-2">èµ„äº§ç®¡ç†</h2>
            <div class="ios-card-static overflow-hidden">
                <div id="asset-summary" class="p-4 border-b border-gray-100 cursor-pointer">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <div class="bg-blue-100/80 p-1.5 rounded text-blue-600 text-xs"><i class="fas fa-wallet"></i></div>
                            <span class="text-sm font-bold text-gray-900">æ€»èµ„äº§</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span id="total-assets" class="text-lg font-bold text-black">Â¥0</span>
                            <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mt-3">
                        <div>
                            <div class="flex justify-between text-[10px] text-gray-500 mb-1">
                                <span>æµåŠ¨ (ç°é‡‘)</span>
                                <span id="val-asset-current">Â¥0</span>
                            </div>
                            <div class="sub-progress-bg"><div id="bar-asset-current" class="sub-progress-fill bg-blue-400" style="width:0%"></div></div>
                        </div>
                        <div>
                            <div class="flex justify-between text-[10px] text-gray-500 mb-1">
                                <span>éæµåŠ¨ (æˆ¿/è½¦)</span>
                                <span id="val-asset-fixed">Â¥0</span>
                            </div>
                            <div class="sub-progress-bg"><div id="bar-asset-fixed" class="sub-progress-fill bg-blue-800" style="width:0%"></div></div>
                        </div>
                    </div>
                </div>

                <div id="liability-summary" class="p-4 border-b border-gray-100 cursor-pointer">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <div class="bg-red-100/80 p-1.5 rounded text-red-500 text-xs"><i class="fas fa-credit-card"></i></div>
                            <span class="text-sm font-bold text-gray-900">æ€»è´Ÿå€º</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span id="total-liabilities" class="text-lg font-bold text-black">Â¥0</span>
                            <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mt-3">
                        <div>
                            <div class="flex justify-between text-[10px] text-gray-500 mb-1">
                                <span>çŸ­æœŸ (ä¿¡ç”¨å¡)</span>
                                <span id="val-debt-short">Â¥0</span>
                            </div>
                            <div class="sub-progress-bg"><div id="bar-debt-short" class="sub-progress-fill bg-red-400" style="width:0%"></div></div>
                        </div>
                        <div>
                            <div class="flex justify-between text-[10px] text-gray-500 mb-1">
                                <span>é•¿æœŸ (æˆ¿è´·)</span>
                                <span id="val-debt-long">Â¥0</span>
                            </div>
                            <div class="sub-progress-bg"><div id="bar-debt-long" class="sub-progress-fill bg-red-800" style="width:0%"></div></div>
                        </div>
                    </div>
                </div>

                <div class="p-4 bg-gray-50/50 flex justify-between items-center">
                    <span class="text-sm font-medium text-gray-500">å‡€èµ„äº§ (Net Worth)</span>
                    <span id="net-worth" class="text-xl font-bold text-gray-900">Â¥0</span>
                </div>

                <button id="btn-add-asset" class="w-full py-3 text-center text-[#007AFF] font-medium text-[15px] border-t border-gray-100">æ·»åŠ èµ„äº§æˆ–è´Ÿå€ºé¡¹ç›®</button>
            </div>
        </section>

        <!-- åº•éƒ¨ -->
        <section class="mt-6">
            <div class="grid grid-cols-2 gap-4">
                <button id="btn-export" class="ios-card p-4 flex flex-col items-center justify-center gap-2 text-gray-600">
                    <i class="fas fa-cloud-download-alt text-2xl text-blue-500"></i>
                    <span class="text-xs font-medium">å¤‡ä»½æ•°æ®</span>
                </button>
                <button id="btn-import" class="ios-card p-4 flex flex-col items-center justify-center gap-2 text-gray-600">
                    <i class="fas fa-cloud-upload-alt text-2xl text-green-500"></i>
                    <span class="text-xs font-medium">æ¢å¤æ•°æ®</span>
                </button>
                <input type="file" id="importFile" style="display:none" accept=".json">
            </div>
            <p class="text-center text-[10px] text-gray-400 mt-8 mb-4">Data stored locally on device</p>
        </section>
    </div>

    <!-- æ¨¡æ€ï¼šå†å² -->
    <div id="modal-history" class="fixed inset-0 z-60 hidden">
        <div class="absolute inset-0 modal-overlay" data-action="close-history"></div>
        <div class="absolute bottom-0 w-full bg-[#F2F2F7] rounded-t-[28px] h-[85vh] flex flex-col modal-content shadow-2xl">
            <div class="w-full flex justify-center pt-3 pb-1" data-action="close-history">
                <div class="w-12 h-1.5 bg-gray-300 rounded-full opacity-50"></div>
            </div>
            <div class="px-5 py-3 flex justify-between items-center border-b border-gray-200 sticky top-0 z-10 bg-[#F2F2F7]/80">
                <h3 id="history-title" class="text-[22px] font-bold text-black">è®°å½•</h3>
                <button data-action="close-history" class="bg-gray-200/80 h-8 w-8 rounded-full flex items-center justify-center text-gray-500"><i class="fas fa-times"></i></button>
            </div>
            <div id="history-list" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
        </div>
    </div>

    <!-- æ¨¡æ€ï¼šè®°è´¦ -->
    <div id="modal-transaction" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 modal-overlay" data-action="close-transaction"></div>
        <div class="absolute bottom-0 w-full bg-white rounded-t-[28px] p-6 pb-6 modal-content shadow-2xl">
            <div class="w-full flex justify-center -mt-2 mb-6"><div class="w-12 h-1.5 bg-gray-200 rounded-full opacity-50"></div></div>
            <div class="space-y-6">
                <div class="flex bg-gray-100 p-1 rounded-xl" role="tablist" aria-label="æ”¶æ”¯ç±»å‹">
                    <button id="btn-expense" class="flex-1 py-2 rounded-lg text-[15px] font-medium bg-white">æ”¯å‡º</button>
                    <button id="btn-income" class="flex-1 py-2 rounded-lg text-[15px] font-medium text-gray-500">æ”¶å…¥</button>
                </div>

                <div id="expense-type-selector">
                    <label class="text-xs text-gray-400 font-medium ml-1 mb-1 block">æ”¯å‡ºæ€§è´¨</label>
                    <div class="flex gap-3">
                        <label class="flex-1 cursor-pointer group">
                            <input type="radio" name="expense_nature" value="variable" checked class="hidden peer">
                            <div class="py-2.5 text-center rounded-lg border border-gray-200 text-gray-500 peer-checked:border-red-500 peer-checked:bg-red-50">å³æ—¶/éå›ºå®š</div>
                        </label>
                        <label class="flex-1 cursor-pointer group">
                            <input type="radio" name="expense_nature" value="fixed" class="hidden peer">
                            <div class="py-2.5 text-center rounded-lg border border-gray-200 text-gray-500 peer-checked:border-red-500 peer-checked:bg-red-50">å›ºå®šæ”¯å‡º</div>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="text-xs text-gray-400 font-medium ml-1">é‡‘é¢</label>
                    <div class="relative mt-1">
                        <span class="absolute left-0 top-1/2 -translate-y-1/2 text-2xl font-bold text-black">Â¥</span>
                        <input id="t-amount" type="number" class="w-full pl-6 text-4xl font-bold border-b border-gray-100 py-2 outline-none" placeholder="0.00" inputmode="decimal">
                    </div>
                </div>

                <div>
                    <label class="text-xs text-gray-400 font-medium ml-1">åˆ†ç±»</label>
                    <div class="grid grid-cols-3 gap-3 mt-2">
                        <select id="t-category" class="col-span-3 bg-gray-50 text-lg rounded-xl px-4 py-3 outline-none appearance-none border border-gray-100"></select>
                    </div>
                </div>

                <button id="btn-save-transaction" class="w-full bg-black text-white py-4 rounded-2xl font-bold text-lg">ä¿å­˜è®°å½•</button>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ€ï¼šèµ„äº§å½•å…¥ -->
    <div id="modal-asset_input" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 modal-overlay" data-action="close-asset"></div>
        <div class="absolute bottom-0 w-full bg-white rounded-t-[28px] p-6 pb-6 modal-content shadow-2xl">
            <div class="w-full flex justify-center -mt-2 mb-6"><div class="w-12 h-1.5 bg-gray-200 rounded-full opacity-50"></div></div>
            <div class="space-y-5">
                <h3 id="asset-modal-title" class="text-xl font-bold text-center">èµ„äº§/è´Ÿå€ºå½•å…¥</h3>
                <div id="asset-type-switch" class="flex bg-gray-100 p-1 rounded-xl">
                    <button id="btn-asset" class="flex-1 py-2 rounded-lg text-[15px] font-medium bg-white">èµ„äº§</button>
                    <button id="btn-liability" class="flex-1 py-2 rounded-lg text-[15px] font-medium text-gray-500">è´Ÿå€º</button>
                </div>

                <div>
                    <label class="text-xs text-gray-400 font-medium ml-1 mb-1 block">ç±»å‹æ€§è´¨</label>
                    <div class="flex gap-3">
                        <label class="flex-1 cursor-pointer group">
                            <input type="radio" name="asset_subtype" value="type1" checked class="hidden peer">
                            <div id="subtype-label-1" class="py-2.5 text-center rounded-lg border border-gray-200 text-gray-500 peer-checked:border-blue-500 peer-checked:bg-blue-50">æµåŠ¨èµ„äº§</div>
                        </label>
                        <label class="flex-1 cursor-pointer group">
                            <input type="radio" name="asset_subtype" value="type2" class="hidden peer">
                            <div id="subtype-label-2" class="py-2.5 text-center rounded-lg border border-gray-200 text-gray-500 peer-checked:border-blue-500 peer-checked:bg-blue-50">éæµåŠ¨èµ„äº§</div>
                        </label>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
                    <input id="a-name" type="text" class="w-full bg-transparent outline-none text-lg font-medium" placeholder="é¡¹ç›®åç§° (å¦‚: æ‹›è¡Œå¡/æˆ¿è´·)">
                </div>

                <div class="bg-gray-50 rounded-xl p-4 border border-gray-100 flex items-center">
                    <span class="text-xl font-bold text-gray-400 mr-2">Â¥</span>
                    <input id="a-amount" type="number" class="w-full bg-transparent outline-none text-2xl font-bold" placeholder="0.00" inputmode="decimal">
                </div>

                <button id="btn-save-asset" class="w-full bg-[#007AFF] text-white py-4 rounded-2xl font-bold text-lg">ç¡®è®¤ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ€ï¼šå¹´åº¦æŠ¥å‘Š -->
    <div id="modal-annual" class="fixed inset-0 z-60 hidden">
        <div class="absolute inset-0 bg-white modal-overlay overflow-y-auto opacity-100"></div>
        <div class="p-5" style="padding-bottom: calc(env(safe-area-inset-bottom) + 100px);">
            <div class="flex justify-between items-center mb-6 pt-2 sticky top-0 bg-white/90 py-2">
                <button id="btn-close-annual" class="h-8 w-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-600"><i class="fas fa-arrow-left"></i></button>
                <h2 class="text-lg font-bold">å¹´åº¦è´¢åŠ¡æŠ¥å‘Š</h2>
                <div style="width:32px"></div>
            </div>

            <!-- å¹´åº¦å†…å®¹ -->
            <div id="annual-content">
                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3 ml-1">èµ„äº§å˜åŠ¨ (å¹´åˆ vs å¹´æœ«)</h3>
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                        <p class="text-xs font-bold text-blue-600 mb-2 flex items-center gap-1"><i class="fas fa-wallet"></i> æ€»èµ„äº§</p>
                        <div class="flex justify-between text-sm text-gray-600 mb-1">
                            <span>å¹´åˆ</span><span id="annual-asset-start">Â¥0</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>å¹´æœ«</span><span id="annual-asset-end">Â¥0</span>
                        </div>
                    </div>
                    <div class="bg-red-50 p-4 rounded-2xl border border-red-100">
                        <p class="text-xs font-bold text-red-600 mb-2 flex items-center gap-1"><i class="fas fa-credit-card"></i> æ€»è´Ÿå€º</p>
                        <div class="flex justify-between text-sm text-gray-600 mb-1">
                            <span>å¹´åˆ</span><span id="annual-debt-start">Â¥0</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>å¹´æœ«</span><span id="annual-debt-end">Â¥0</span>
                        </div>
                    </div>
                </div>

                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4 ml-1">æœˆåº¦æ”¶æ”¯è¶‹åŠ¿</h3>
                <div class="bg-white rounded-2xl border border-gray-100 p-4 mb-8 shadow-sm h-64">
                    <canvas id="annualChart"></canvas>
                </div>
            </div>
        </div>

        <div class="floating-year-selector pointer-events-auto">
            <div class="flex items-center gap-2">
                <button id="year-prev" class="w-10 h-8 flex items-center justify-center text-gray-500"><i class="fas fa-chevron-left"></i></button>
                <span id="report-year-display" class="px-3 font-bold text-lg tabular-nums">2026</span>
                <button id="year-next" class="w-10 h-8 flex items-center justify-center text-gray-500"><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
    </div>

    <script>
    (function(){
        'use strict';

        /* =======================
           æ•°æ®ä¸åˆå§‹è®¾ç½®
           ======================= */
        let financeData = { records: [] };
        const storageKey = 'myFinanceData_v6_opt';
        let viewDate = new Date();
        let currentTransType = 'expense';
        let currentAssetType = 'asset';
        let expenseChart = null;
        let annualChart = null;
        let reportYear = new Date().getFullYear();

        // èŠ‚æµ & ç©ºé—²ä¿å­˜ localStorageï¼ˆé¿å…é¢‘ç¹å†™ï¼‰
        let saveTimer = null;
        let pendingSave = false;
        function scheduleSave() {
            pendingSave = true;
            if (typeof requestIdleCallback === 'function') {
                requestIdleCallback(() => { localStorage.setItem(storageKey, JSON.stringify(financeData)); pendingSave=false; }, {timeout:1000});
            } else {
                if (saveTimer) clearTimeout(saveTimer);
                saveTimer = setTimeout(() => { localStorage.setItem(storageKey, JSON.stringify(financeData)); pendingSave=false; }, 800);
            }
        }

        // é˜²æŠ–å·¥å…·
        function debounce(fn, wait){ let t; return function(...a){ clearTimeout(t); t = setTimeout(()=>fn.apply(this,a), wait); }; }

        /* =======================
           DOM ç¼“å­˜ï¼ˆåªæŸ¥ä¸€æ¬¡ï¼‰
           ======================= */
        const DOM = {
            currentDate: document.getElementById('current-date'),
            nativeMonthInputs: [document.getElementById('native-month-input'), document.getElementById('mini-month-input')],
            btnAnnual: document.getElementById('btn-annual'),
            cashFlowDisplay: document.getElementById('cash-flow-display'),
            totalIncome: document.getElementById('total-income'),
            totalExpense: document.getElementById('total-expense'),
            expenseCanvas: document.getElementById('expenseChart'),
            expenseLegend: document.getElementById('expense-legend'),
            btnAddTransaction: document.getElementById('btn-add-transaction'),
            btnAddAsset: document.getElementById('btn-add-asset'),
            totalAssets: document.getElementById('total-assets'),
            totalLiabilities: document.getElementById('total-liabilities'),
            netWorth: document.getElementById('net-worth'),
            valAssetCurrent: document.getElementById('val-asset-current'),
            valAssetFixed: document.getElementById('val-asset-fixed'),
            valDebtShort: document.getElementById('val-debt-short'),
            valDebtLong: document.getElementById('val-debt-long'),
            barAssetCurrent: document.getElementById('bar-asset-current'),
            barAssetFixed: document.getElementById('bar-asset-fixed'),
            barDebtShort: document.getElementById('bar-debt-short'),
            barDebtLong: document.getElementById('bar-debt-long'),
            modalHistory: document.getElementById('modal-history'),
            historyTitle: document.getElementById('history-title'),
            historyList: document.getElementById('history-list'),
            modalTransaction: document.getElementById('modal-transaction'),
            modalAssetInput: document.getElementById('modal-asset_input'),
            btnExpense: document.getElementById('btn-expense'),
            btnIncome: document.getElementById('btn-income'),
            expenseTypeSelector: document.getElementById('expense-type-selector'),
            tAmount: document.getElementById('t-amount'),
            tCategory: document.getElementById('t-category'),
            btnSaveTransaction: document.getElementById('btn-save-transaction'),
            aName: document.getElementById('a-name'),
            aAmount: document.getElementById('a-amount'),
            btnSaveAsset: document.getElementById('btn-save-asset'),
            modalAnnual: document.getElementById('modal-annual'),
            reportYearDisplay: document.getElementById('report-year-display'),
            btnYearPrev: document.getElementById('year-prev'),
            btnYearNext: document.getElementById('year-next'),
            annualCanvas: document.getElementById('annualChart'),
            btnExport: document.getElementById('btn-export'),
            btnImport: document.getElementById('btn-import'),
            importFile: document.getElementById('importFile'),
            btnCloseAnnual: document.getElementById('btn-close-annual'),
            blockIncome: document.getElementById('block-income'),
            blockExpense: document.getElementById('block-expense')
        };

        /* =======================
           ç±»åˆ« & åˆå§‹æ•°æ®
           ======================= */
        const categories = {
            expense_variable: [
                {val: 'é¤é¥®', label: 'ğŸ” é¤é¥®ç¾é£Ÿ'}, {val: 'äº¤é€š', label: 'ğŸš— äº¤é€šå‡ºè¡Œ'},
                {val: 'è´­ç‰©', label: 'ğŸ›ï¸ è´­ç‰©æ¶ˆè´¹'}, {val: 'æ°´ç”µæ°”', label: 'âš¡ æ°´ç”µæ°”'},
                {val: 'å¨±ä¹', label: 'ğŸ® ä¼‘é—²å¨±ä¹'}, {val: 'åŒ»ç–—', label: 'ğŸ’Š åŒ»ç–—å¥åº·'},
                {val: 'å…¶ä»–', label: 'ğŸ“ å…¶ä»–æ”¯å‡º'}
            ],
            expense_fixed: [
                {val: 'æˆ¿ç§Ÿ', label: 'ğŸ  æˆ¿ç§Ÿ'}, {val: 'ç‰©ä¸šè´¹', label: 'ğŸ¢ ç‰©ä¸šè´¹'},
                {val: 'æˆ¿è´·', label: 'ğŸ¦ æˆ¿è´·'}, {val: 'ä¸ªäººè´·æ¬¾', label: 'ğŸ’³ ä¸ªäººè´·æ¬¾ (çŸ­æœŸ)'},
                {val: 'æ±½è½¦è´·æ¬¾', label: 'ğŸš˜ æ±½è½¦è´·æ¬¾'}
            ],
            income: [
                {val: 'å·¥èµ„', label: 'ğŸ’° å·¥èµ„æ”¶å…¥'}, {val: 'ç†è´¢', label: 'ğŸ“ˆ æŠ•èµ„ç†è´¢'},
                {val: 'å…¶ä»–', label: 'ğŸ“ å…¶ä»–æ”¶å…¥'}
            ]
        };

        /* =======================
           Helper å‡½æ•°
           ======================= */
        function fmtMoney(v){ return 'Â¥' + Number(v||0).toLocaleString(); }
        function getIcon(c){
            const map = { 'é¤é¥®':'fa-utensils', 'äº¤é€š':'fa-car', 'è´­ç‰©':'fa-shopping-bag', 'æ°´ç”µæ°”':'fa-bolt', 'å¨±ä¹':'fa-gamepad', 'åŒ»ç–—':'fa-briefcase-medical', 'å…¶ä»–':'fa-sticky-note', 'å·¥èµ„':'fa-coins', 'ç†è´¢':'fa-chart-line', 'æˆ¿ç§Ÿ':'fa-house-user', 'ç‰©ä¸šè´¹':'fa-building', 'æˆ¿è´·':'fa-file-invoice-dollar', 'ä¸ªäººè´·æ¬¾':'fa-credit-card', 'æ±½è½¦è´·æ¬¾':'fa-car-side' };
            return map[c] || 'fa-tag';
        }

        /* =======================
           åˆå§‹åŒ–ï¼šè¯»å–ç¼“å­˜ã€ç»‘å®šäº‹ä»¶ã€åˆå§‹åŒ–å›¾è¡¨
           ======================= */
        function init(){
            // å°è¯•åŠ è½½
            try {
                const saved = localStorage.getItem(storageKey);
                if (saved) financeData = JSON.parse(saved);
            } catch(e){ console.warn('load fail', e); }

            // ç»‘å®šé€šç”¨äº‹ä»¶ï¼ˆä½¿ç”¨è¢«åŠ¨ç›‘å¬ä»¥ä¼˜åŒ–æ»šåŠ¨/è§¦æ‘¸ï¼‰
            DOM.nativeMonthInputs.forEach(input => {
                input.addEventListener('change', onMonthChange, {passive:true});
            });

            DOM.btnAnnual.addEventListener('click', openAnnualReport, {passive:true});
            DOM.btnAddTransaction.addEventListener('click', () => openModal('transaction'), {passive:true});
            DOM.btnAddAsset.addEventListener('click', () => openModal('asset_input'), {passive:true});

            // å¯¼å‡º/å¯¼å…¥
            DOM.btnExport.addEventListener('click', exportData, {passive:true});
            DOM.btnImport.addEventListener('click', () => DOM.importFile.click(), {passive:true});
            DOM.importFile.addEventListener('change', importData);

            // å†å²å¼¹çª—å…³é—­ï¼ˆäº‹ä»¶å§”æ‰˜ï¼‰
            document.addEventListener('click', function(e){
                const action = e.target && (e.target.getAttribute && (e.target.getAttribute('data-action')));
                if(action === 'close-history') closeModal('history');
                if(action === 'close-transaction') closeModal('transaction');
                if(action === 'close-asset') closeModal('asset_input');
            }, {passive:true});

            // ç»‘å®šäº¤æ˜“æ¨¡æ€æŒ‰é’®
            DOM.btnExpense.addEventListener('click', () => setTransType('expense'));
            DOM.btnIncome.addEventListener('click', () => setTransType('income'));
            document.getElementsByName('expense_nature').forEach(r => r.addEventListener('change', () => updateCategoryOptions('expense')));
            DOM.btnSaveTransaction.addEventListener('click', () => saveRecord('transaction'));
            DOM.btnSaveAsset.addEventListener('click', () => saveRecord('asset'));

            // å¹´æŠ¥æ§ä»¶
            DOM.btnYearPrev.addEventListener('click', () => changeReportYear(-1), {passive:true});
            DOM.btnYearNext.addEventListener('click', () => changeReportYear(1), {passive:true});
            DOM.btnCloseAnnual.addEventListener('click', () => closeModal('annual'), {passive:true});

            // å¿«é€Ÿæ‰“å¼€å†å²
            DOM.blockIncome.addEventListener('click', ()=> showHistory('income'));
            DOM.blockExpense.addEventListener('click', ()=> showHistory('expense'));
            DOM.assetSummary?.addEventListener?.('click', ()=> showHistory('asset')); // optional
            DOM.liabilitySummary?.addEventListener?.('click', ()=> showHistory('liability'));

            // åˆå§‹åŒ– Chartsï¼ˆä¸€æ¬¡åˆ›å»ºï¼Œåç»­ updateï¼‰
            initExpenseChart();
            initAnnualChart();

            // é¦–æ¬¡æ›´æ–° UI
            updateCategoryOptions('expense');
            updateUI();
        }

        /* =======================
           æœˆä»½åˆ‡æ¢
           ======================= */
        function onMonthChange(e){
            if(!e.target.value) return;
            const parts = e.target.value.split('-');
            viewDate = new Date(Number(parts[0]), Number(parts[1]) - 1, 1);
            updateUI();
        }

        /* =======================
           è·å–æœˆæœ«å¿«ç…§ï¼ˆé‡ç”¨åŸæœ‰é€»è¾‘ï¼Œä¿æŒè¯­ä¹‰ï¼‰
           ======================= */
        function getMonthlySnapshot(year, month) {
            const allNames = new Set();
            financeData.records.forEach(r => { if(r.type === 'asset' || r.type === 'liability') allNames.add(r.name); });
            const snapshot = {};
            const targetTime = new Date(year, month + 1, 0, 23, 59, 59).getTime();
            allNames.forEach(name => {
                const history = financeData.records
                    .filter(r => r.name === name)
                    .filter(r => new Date(r.date).getTime() <= targetTime)
                    .sort((a,b) => new Date(b.date) - new Date(a.date));
                if(history.length>0){
                    const latest = history[0];
                    const rDate = new Date(latest.date);
                    const isCurrentMonth = (rDate.getFullYear() === year && rDate.getMonth() === month);
                    snapshot[name] = { amount: parseFloat(latest.amount), type: latest.type, subtype: latest.subtype, recordId: isCurrentMonth ? latest.id : null, date: latest.date };
                }
            });
            return snapshot;
        }

        /* =======================
           æ›´æ–° UIï¼ˆæ‰€æœ‰ DOM å†™æ“ä½œé€šè¿‡ requestAnimationFrame æ‰¹é‡ï¼‰
           ======================= */
        let rafPending = false;
        function updateUI(){
            if(rafPending) return;
            rafPending = true;
            requestAnimationFrame(() => {
                try{
                    const vYear = viewDate.getFullYear(), vMonth = viewDate.getMonth();
                    // æ›´æ–°é¡¶éƒ¨æ—¥æœŸæ˜¾ç¤ºä¸ native input å€¼ï¼ˆä¸€æ¬¡å†™ï¼‰
                    DOM.currentDate.innerText = `${vYear}å¹´${vMonth+1}æœˆ`;
                    const dateStr = `${vYear}-${String(vMonth+1).padStart(2,'0')}`;
                    DOM.nativeMonthInputs.forEach(i=>i.value = dateStr);

                    // è®¡ç®—å½“æœˆæ”¶æ”¯
                    let totalInc=0, totalExp=0, catExp={};
                    financeData.records.forEach(r=>{
                        if(r.type==='income' || r.type==='expense'){
                            const d=new Date(r.date);
                            if(d.getFullYear()===vYear && d.getMonth()===vMonth){
                                const amt = parseFloat(r.amount)||0;
                                if(r.type==='income') totalInc += amt;
                                else { totalExp += amt; catExp[r.category] = (catExp[r.category]||0)+amt; }
                            }
                        }
                    });

                    // èµ„äº§å¿«ç…§
                    const snapshot = getMonthlySnapshot(vYear, vMonth);
                    let totals = { asset:0, liability:0, assetCurrent:0, assetFixed:0, debtShort:0, debtLong:0 };
                    Object.values(snapshot).forEach(item=>{
                        const amt = item.amount||0;
                        if(item.type==='asset'){ totals.asset += amt; if(item.subtype==='current') totals.assetCurrent += amt; else totals.assetFixed += amt; }
                        else { totals.liability += amt; if(item.subtype==='short') totals.debtShort += amt; else totals.debtLong += amt; }
                    });

                    // DOM æ›´æ–°
                    DOM.totalIncome.innerText = fmtMoney(totalInc);
                    DOM.totalExpense.innerText = fmtMoney(totalExp);
                    const cashFlow = totalInc - totalExp;
                    DOM.cashFlowDisplay.innerText = fmtMoney(cashFlow.toFixed(2));
                    DOM.cashFlowDisplay.classList.toggle('text-red-500', cashFlow < 0);

                    DOM.totalAssets.innerText = fmtMoney(totals.asset);
                    DOM.totalLiabilities.innerText = fmtMoney(totals.liability);
                    DOM.netWorth.innerText = fmtMoney(totals.asset - totals.liability);

                    DOM.valAssetCurrent.innerText = fmtMoney(totals.assetCurrent);
                    DOM.valAssetFixed.innerText = fmtMoney(totals.assetFixed);
                    DOM.valDebtShort.innerText = fmtMoney(totals.debtShort);
                    DOM.valDebtLong.innerText = fmtMoney(totals.debtLong);

                    // è¿›åº¦æ¡ï¼ˆå†™å…¥æ ·å¼ï¼‰
                    const maxAsset = Math.max(totals.asset, 1);
                    const maxDebt = Math.max(totals.liability, 1);
                    DOM.barAssetCurrent.style.width = `${(totals.assetCurrent/maxAsset)*100}%`;
                    DOM.barAssetFixed.style.width = `${(totals.assetFixed/maxAsset)*100}%`;
                    DOM.barDebtShort.style.width = `${(totals.debtShort/maxDebt)*100}%`;
                    DOM.barDebtLong.style.width = `${(totals.debtLong/maxDebt)*100}%`;

                    // Chart & legend æ›´æ–°ï¼ˆChart å†…éƒ¨ä¼šå°½é‡åªæ›´æ–°æ•°æ®ï¼‰
                    updateChartAndList(catExp, totalExp);

                    // å¦‚æœå¯¹æ€§èƒ½æ•æ„Ÿï¼Œå»¶è¿Ÿä¿å­˜åˆ°æœ¬åœ°ï¼ˆé¿å…é˜»å¡ï¼‰
                    scheduleSave();
                } finally {
                    rafPending = false;
                }
            });
        }

        /* =======================
           åˆ—è¡¨ / å†å² æ˜¾ç¤ºä¼˜åŒ–ï¼ˆä½¿ç”¨ fragment + IntersectionObserver åŠ¨æ•ˆï¼‰
           ======================= */
        const listObserver = new IntersectionObserver((entries) => {
            entries.forEach(e => { if(e.isIntersecting){ e.target.classList.add('in'); listObserver.unobserve(e.target); } });
        }, { rootMargin: '0px 0px -10px 0px', threshold: 0.1 });

        function showHistory(type){
            const titles = { income:'æ”¶å…¥æ˜ç»†', expense:'æ”¯å‡ºæ˜ç»†', asset:'æœ¬æœˆèµ„äº§æ¸…å•', liability:'æœ¬æœˆè´Ÿå€ºæ¸…å•' };
            DOM.historyTitle.innerText = titles[type];
            DOM.historyList.innerHTML = '';
            const vYear = viewDate.getFullYear(), vMonth = viewDate.getMonth();

            if(type==='income' || type==='expense'){
                const filtered = financeData.records.filter(r => {
                    const d = new Date(r.date);
                    return r.type === type && d.getFullYear()===vYear && d.getMonth()===vMonth;
                }).slice().reverse();

                if(filtered.length===0){
                    DOM.historyList.innerHTML = `<div class="flex flex-col items-center justify-center mt-20 opacity-50"><p class="text-sm text-gray-400">æœ¬æœˆæš‚æ— è®°å½•</p></div>`;
                } else {
                    const frag = document.createDocumentFragment();
                    filtered.forEach((r, idx)=>{
                        const div = document.createElement('div');
                        div.className = "bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm mb-2 list-item-anim";
                        div.innerHTML = `
                            <div class="flex items-center gap-3">
                                <div class="h-10 w-10 rounded-full ${type==='income'?'bg-green-100 text-green-600':'bg-red-100 text-red-500'} flex items-center justify-center text-sm">
                                    <i class="fas ${getIcon(r.category)}"></i>
                                </div>
                                <div>
                                    <p class="font-bold text-gray-900 text-[15px]">${r.category}</p>
                                    <p class="text-xs text-gray-400 mt-0.5">${r.date.split('T')[0]}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-lg ${type==='income'?'text-green-600':'text-black'}">${type==='income'?'+':'-'}Â¥${parseFloat(r.amount).toLocaleString()}</p>
                                <button data-delete="${r.id}" class="text-xs text-red-400 mt-1 px-2 py-1 active:bg-red-50 rounded">åˆ é™¤</button>
                            </div>
                        `;
                        frag.appendChild(div);
                    });
                    DOM.historyList.appendChild(frag);
                    // ç»‘å®šåˆ é™¤å§”æ‰˜
                    DOM.historyList.querySelectorAll('[data-delete]').forEach(btn => btn.addEventListener('click', (e)=>{
                        e.stopPropagation();
                        const id = btn.getAttribute('data-delete');
                        deleteRecord(id, type);
                    }));
                    // Observe items for animation
                    DOM.historyList.querySelectorAll('.list-item-anim').forEach(el => listObserver.observe(el));
                }
            } else {
                const snapshot = getMonthlySnapshot(vYear, vMonth);
                const items = Object.keys(snapshot).map(name => ({ name, ...snapshot[name] })).filter(it => it.type === type && Math.abs(it.amount) > 0.01);
                if(items.length===0){
                    DOM.historyList.innerHTML = `<div class="flex flex-col items-center justify-center mt-20 opacity-50"><p class="text-sm text-gray-400">æœ¬æœˆæ— ${type==='asset'?'èµ„äº§':'è´Ÿå€º'}é¡¹ç›®</p></div>`;
                } else {
                    const frag = document.createDocumentFragment();
                    items.forEach(it=>{
                        const div = document.createElement('div');
                        div.className = "bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm mb-2 list-item-anim cursor-pointer";
                        const subtype = it.type==='asset' ? (it.subtype==='fixed'?'éæµåŠ¨':'æµåŠ¨') : (it.subtype==='long'?'é•¿æœŸ':'çŸ­æœŸ');
                        const isInherited = it.recordId===null;
                        const deleteBtn = !isInherited ? `<button data-delete="${it.recordId}" class="text-xs text-red-500 mt-2 px-2 py-1 bg-red-50 rounded">æ’¤é”€æœ¬æœˆè®°å½•</button>` : '';
                        div.innerHTML = `
                            <div class="flex items-center gap-3">
                                <div class="h-10 w-10 rounded-full ${type==='asset' ? 'bg-blue-100 text-blue-600' : 'bg-red-100 text-red-500'} flex items-center justify-center text-sm">
                                    <i class="fas ${type==='asset' ? 'fa-wallet' : 'fa-credit-card'}"></i>
                                </div>
                                <div>
                                    <p class="font-bold text-gray-900 text-[15px]">${it.name}</p>
                                    <p class="text-xs text-gray-400 mt-0.5 inline-block px-1.5 rounded">${subtype} ${isInherited?'<span class="text-[10px] text-gray-400 ml-1">(ç»§æ‰¿ä¸Šæœˆ)</span>':'<span class="text-[10px] text-blue-500 ml-1">(æœ¬æœˆå·²æ›´æ–°)</span>'}</p>
                                </div>
                            </div>
                            <div class="text-right flex flex-col items-end">
                                <p class="font-bold text-lg text-black">Â¥${it.amount.toLocaleString()}</p>
                                <div class="flex gap-2">
                                    ${deleteBtn}
                                    <p class="text-xs text-blue-500 mt-2 py-1">ä¿®æ”¹</p>
                                </div>
                            </div>
                        `;
                        frag.appendChild(div);
                    });
                    DOM.historyList.appendChild(frag);
                    // åˆ é™¤æŒ‰é’®å§”æ‰˜
                    DOM.historyList.querySelectorAll('[data-delete]').forEach(btn => btn.addEventListener('click', (e)=>{
                        e.stopPropagation();
                        const id = btn.getAttribute('data-delete');
                        deleteRecord(id, type);
                    }));
                    DOM.historyList.querySelectorAll('.list-item-anim').forEach(el => listObserver.observe(el));
                }
            }

            openModal('history');
        }

        /* =======================
           ä¿å­˜ / åˆ é™¤ è®°å½•
           ======================= */
        function saveRecord(mode){
            let recordDate = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1, 12, 0, 0);
            const now = new Date();
            if(now.getFullYear() === viewDate.getFullYear() && now.getMonth() === viewDate.getMonth()) recordDate = now;

            if(mode === 'transaction'){
                const amt = DOM.tAmount.value;
                if(!amt) { alert('è¯·å¡«å†™é‡‘é¢'); return; }
                const record = { id: Date.now().toString(), date: recordDate.toISOString(), type: currentTransType, amount: amt, category: DOM.tCategory.value };
                if(currentTransType === 'expense'){
                    const radios = document.getElementsByName('expense_nature');
                    for(let r of radios) if(r.checked) record.expenseType = r.value;
                }
                financeData.records.push(record);
                DOM.tAmount.value = '';
                closeModal('transaction');
            } else {
                const amt = DOM.aAmount.value, name = DOM.aName.value;
                if(!amt || !name) { alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯'); return; }
                const radios = document.getElementsByName('asset_subtype');
                let subVal = 'type1';
                for(let r of radios) if(r.checked) subVal = r.value;
                const vYear = viewDate.getFullYear(), vMonth = viewDate.getMonth();
                let existingIndex = -1;
                for(let i=0;i<financeData.records.length;i++){
                    const r=financeData.records[i];
                    if(r.name===name && (r.type==='asset' || r.type==='liability')) {
                        const d=new Date(r.date);
                        if(d.getFullYear()===vYear && d.getMonth()===vMonth) { existingIndex = i; break; }
                    }
                }
                const newRecord = {
                    id: existingIndex !== -1 ? financeData.records[existingIndex].id : Date.now().toString(),
                    date: recordDate.toISOString(),
                    type: currentAssetType,
                    amount: amt,
                    name: name,
                    subtype: (currentAssetType==='asset') ? (subVal==='type1'?'current':'fixed') : (subVal==='type1'?'short':'long')
                };
                if(existingIndex !== -1) financeData.records[existingIndex] = newRecord; else financeData.records.push(newRecord);
                DOM.aAmount.value = ''; DOM.aName.value = '';
                closeModal('asset_input');
            }
            updateUI();
        }

        function deleteRecord(id, type){
            if(!confirm('âš ï¸ ç¡®å®šè¦æ’¤é”€æœ¬æ¡è®°å½•å—ï¼Ÿ')) return;
            financeData.records = financeData.records.filter(r => r.id !== id);
            updateUI();
            // å¦‚æœå†å²å¼¹çª—æ‰“å¼€ï¼Œåˆ·æ–°å®ƒ
            if(!DOM.modalHistory.classList.contains('hidden')) showHistory(type);
        }

        /* =======================
           å¹´æŠ¥é€»è¾‘ï¼ˆä½¿ç”¨ä¸€æ¬¡åˆå§‹åŒ–çš„å›¾è¡¨ï¼‰
           ======================= */
        function updateAnnualReport(){
            DOM.reportYearDisplay.innerText = reportYear;
            let monthlyData = Array.from({length:12},()=>({inc:0, exp:0}));
            let yTotalInc=0,yTotalExp=0;
            financeData.records.forEach(r=>{
                if(r.type==='income' || r.type==='expense'){
                    const d=new Date(r.date);
                    if(d.getFullYear()===reportYear){
                        const amt = parseFloat(r.amount)||0;
                        if(r.type==='income'){ monthlyData[d.getMonth()].inc += amt; yTotalInc += amt; } else { monthlyData[d.getMonth()].exp += amt; yTotalExp += amt; }
                    }
                }
            });

            const startSnapshot = getMonthlySnapshot(reportYear, 0);
            const now = new Date();
            let endMonth = 11;
            if(reportYear === now.getFullYear()) endMonth = now.getMonth();
            const endSnapshot = getMonthlySnapshot(reportYear, endMonth);

            let sAsset=0,sDebt=0,eAsset=0,eDebt=0;
            Object.values(startSnapshot).forEach(v=>{ if(v.type==='asset') sAsset+=v.amount; else sDebt+=v.amount; });
            Object.values(endSnapshot).forEach(v=>{ if(v.type==='asset') eAsset+=v.amount; else eDebt+=v.amount; });

            document.getElementById('annual-income').innerText = fmtMoney(yTotalInc);
            document.getElementById('annual-expense').innerText = fmtMoney(yTotalExp);
            document.getElementById('annual-balance') && (document.getElementById('annual-balance').innerText = fmtMoney(yTotalInc - yTotalExp));
            document.getElementById('annual-asset-start').innerText = fmtMoney(sAsset);
            document.getElementById('annual-asset-end').innerText = fmtMoney(eAsset);
            document.getElementById('annual-debt-start').innerText = fmtMoney(sDebt);
            document.getElementById('annual-debt-end').innerText = fmtMoney(eDebt);

            // å¹´åº¦æ˜ç»†éƒ¨åˆ†ä¿æŒä¸ä¹‹å‰ç±»ä¼¼ï¼ˆéå…³é”®è·¯å¾„ï¼Œè‹¥æ•°æ®é‡å¤§å¯ä»¥å»¶åæ¸²æŸ“ï¼‰
            // æ›´æ–°å›¾è¡¨æ•°æ®ï¼ˆç›´æ¥èµ‹å€¼å updateï¼‰
            if(annualChart){
                annualChart.data.datasets[0].data = monthlyData.map(d=>d.inc);
                annualChart.data.datasets[1].data = monthlyData.map(d=>d.exp);
                annualChart.update('active');
            }
        }

        function changeReportYear(delta){ reportYear += delta; updateAnnualReport(); }

        /* =======================
           Charts åˆå§‹åŒ–ä¸æ›´æ–°ï¼ˆåªå»ºä¸€æ¬¡ï¼‰
           ======================= */
        function initExpenseChart(){
            const ctx = DOM.expenseCanvas.getContext('2d');
            const config = {
                type: 'doughnut',
                data: { labels: ['æ— '], datasets:[{ data:[1], backgroundColor:['#F2F2F7'], borderWidth:0 }] },
                options: {
                    responsive:true, maintainAspectRatio:false, cutout: '75%',
                    plugins:{ legend:{ display:false }, tooltip:{ enabled:false } }
                }
            };
            expenseChart = new Chart(ctx, config);
        }

        function updateExpenseChart(displayData){
            if(!expenseChart) return;
            expenseChart.data.labels = Object.keys(displayData);
            expenseChart.data.datasets[0].data = Object.values(displayData);
            // colors map
            const colorMap = {
                'é¤é¥®': '#FF3B30', 'äº¤é€š': '#007AFF', 'è´­ç‰©': '#FF9500', 'æ°´ç”µæ°”': '#AF52DE',
                'å¨±ä¹': '#5856D6', 'åŒ»ç–—': '#FF2D55', 'å…¶ä»–': '#8E8E93', 'æˆ¿ç§Ÿ': '#FF9F0A',
                'ç‰©ä¸šè´¹': '#FFD60A','æˆ¿è´·':'#AC8E68','ä¸ªäººè´·æ¬¾':'#FF453A','æ±½è½¦è´·æ¬¾':'#30B0C7','æ— ':'#F2F2F7'
            };
            expenseChart.data.datasets[0].backgroundColor = Object.keys(displayData).map(l => colorMap[l]||'#8E8E93');
            expenseChart.update('active');
        }

        function initAnnualChart(){
            const ctx = DOM.annualCanvas.getContext('2d');
            annualChart = new Chart(ctx, {
                type: 'bar',
                data: { labels:['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'],
                        datasets:[
                            { label:'æ”¶å…¥', data:new Array(12).fill(0), backgroundColor:'#34C759', borderRadius:4, barPercentage:0.6 },
                            { label:'æ”¯å‡º', data:new Array(12).fill(0), backgroundColor:'#FF3B30', borderRadius:4, barPercentage:0.6 }
                        ] },
                options: { responsive:true, maintainAspectRatio:false, scales:{ x:{ grid:{ display:false } }, y:{ display:false } }, plugins:{ legend:{ position:'top', align:'end' } } }
            });
        }

        /* =======================
           Chart & Legend æ›´æ–°ï¼ˆåˆå¹¶å¹¶åªåšå¿…è¦ DOM æ›´æ”¹ï¼‰
           ======================= */
        function updateChartAndList(data, totalExp){
            const isEmpty = Object.keys(data).length === 0;
            const displayData = isEmpty ? {'æ— ':1} : data;
            updateExpenseChart(displayData);

            // æ„å»º legend ä½¿ç”¨ fragmentï¼ˆé¿å…ä¸åœ innerHTMLï¼‰
            const frag = document.createDocumentFragment();
            if(!isEmpty){
                const entries = Object.entries(data).sort((a,b)=>b[1]-a[1]);
                const colorMap = {
                    'é¤é¥®': '#FF3B30', 'äº¤é€š': '#007AFF', 'è´­ç‰©': '#FF9500', 'æ°´ç”µæ°”': '#AF52DE',
                    'å¨±ä¹': '#5856D6', 'åŒ»ç–—': '#FF2D55', 'å…¶ä»–': '#8E8E93', 'æˆ¿ç§Ÿ': '#FF9F0A',
                    'ç‰©ä¸šè´¹': '#FFD60A','æˆ¿è´·':'#AC8E68','ä¸ªäººè´·æ¬¾':'#FF453A','æ±½è½¦è´·æ¬¾':'#30B0C7'
                };
                entries.forEach(([cat, amount], index) => {
                    const percent = totalExp>0 ? ((amount/totalExp)*100).toFixed(1) : 0;
                    const color = colorMap[cat] || '#8E8E93';
                    const wrapper = document.createElement('div');
                    wrapper.className = 'legend-row';
                    wrapper.innerHTML = `
                        <div class="flex items-center justify-between text-sm mb-1">
                            <div class="flex items-center gap-2"><i class="fas ${getIcon(cat)} w-5 text-center" style="color:${color}"></i><span class="font-medium text-gray-700">${cat}</span></div>
                            <div class="flex items-center gap-3"><span class="text-xs font-bold text-gray-400">${percent}%</span><span class="font-bold text-gray-900">Â¥${amount.toLocaleString()}</span></div>
                        </div>
                        <div class="rank-bar-bg"><div class="rank-bar-fill" style="width:${percent}%; background-color:${color}"></div></div>
                    `;
                    frag.appendChild(wrapper);
                });
            } else {
                const p = document.createElement('p');
                p.className = 'text-center text-xs text-gray-400 py-2';
                p.textContent = 'æœ¬æœˆæš‚æ— æ”¯å‡ºè®°å½•';
                frag.appendChild(p);
            }

            // å¿«é€Ÿæ›¿æ¢ï¼ˆä¸€æ¬¡å†™å…¥ï¼‰
            DOM.expenseLegend.innerHTML = '';
            DOM.expenseLegend.appendChild(frag);
        }

        /* =======================
           åˆ†ç±»ä¸‹æ‹‰åŠ¨æ€ç”Ÿæˆ
           ======================= */
        function updateCategoryOptions(type){
            DOM.tCategory.innerHTML = '';
            let list = [];
            if(type === 'income') list = categories.income;
            else {
                const radios = document.getElementsByName('expense_nature');
                let isFixed = false;
                for(let r of radios){ if(r.checked && r.value === 'fixed') isFixed = true; }
                list = isFixed ? categories.expense_fixed : categories.expense_variable;
            }
            const frag = document.createDocumentFragment();
            list.forEach(c => { const o=document.createElement('option'); o.value=c.val; o.innerText=c.label; frag.appendChild(o); });
            DOM.tCategory.appendChild(frag);
        }

        /* =======================
           Modal open/closeï¼ˆå¤ç”¨ class åˆ‡æ¢ä»¥ä¿ç•™ CSS åŠ¨ç”»ï¼‰
           ======================= */
        function openModal(name){
            const m = document.getElementById(`modal-${name}`);
            if(!m) return;
            m.classList.remove('hidden'); void m.offsetWidth; m.classList.add('modal-enter');
            // focus ç®¡ç†
        }
        function closeModal(name){
            const m = document.getElementById(`modal-${name}`);
            if(!m) return;
            m.classList.remove('modal-enter'); setTimeout(()=>m.classList.add('hidden'), 360);
        }

        function openAnnualReport(){
            reportYear = new Date().getFullYear();
            updateAnnualReport();
            openModal('annual');
        }

        /* =======================
           äº¤æ˜“ç±»å‹ / èµ„äº§ç±»å‹ åˆ‡æ¢
           ======================= */
        function setTransType(t){
            currentTransType = t;
            const active = "flex-1 py-2 rounded-lg text-[15px] font-medium shadow-sm bg-white text-black";
            const inactive = "flex-1 py-2 rounded-lg text-[15px] font-medium text-gray-500";
            DOM.btnExpense.className = t === 'expense' ? active : inactive;
            DOM.btnIncome.className = t === 'income' ? active : inactive;
            DOM.expenseTypeSelector.classList.toggle('hidden', t !== 'expense');
            updateCategoryOptions(t);
        }

        function setAssetType(t){
            currentAssetType = t;
            const active = "flex-1 py-2 rounded-lg text-[15px] font-medium shadow-sm bg-white text-black";
            const inactive = "flex-1 py-2 rounded-lg text-[15px] font-medium text-gray-500";
            document.getElementById('btn-asset').className = t==='asset' ? active : inactive;
            document.getElementById('btn-liability').className = t==='liability' ? active : inactive;
            document.getElementById('subtype-label-1').innerText = t==='asset' ? "æµåŠ¨èµ„äº§ (ç°é‡‘)" : "çŸ­æœŸè´Ÿå€º (<1å¹´)";
            document.getElementById('subtype-label-2').innerText = t==='asset' ? "éæµåŠ¨èµ„äº§ (æˆ¿è½¦)" : "é•¿æœŸè´Ÿå€º (>1å¹´)";
        }
        // expose setAssetType to button listeners
        document.getElementById('btn-asset').addEventListener('click', ()=> setAssetType('asset'));
        document.getElementById('btn-liability').addEventListener('click', ()=> setAssetType('liability'));

        /* =======================
           å¯¼å‡º / å¯¼å…¥ï¼ˆç®€åŒ–å®ç°ï¼Œå¹¶å¯¹æ–‡ä»¶è§£æåšå®¹é”™ï¼‰
           ======================= */
        function exportData(){
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(financeData));
            const a = document.createElement('a'); a.href = dataUri; a.download = `FinPro_${new Date().toISOString().slice(0,10)}.json`; a.click();
        }

        function importData(e){
            const input = e.target;
            if(!input.files || !input.files[0]) return;
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(ev){
                try {
                    const json = JSON.parse(ev.target.result);
                    if(!json.records || !Array.isArray(json.records)) throw new Error('Invalid format');
                    financeData = json;
                    updateUI();
                    alert('æ•°æ®æ¢å¤æˆåŠŸï¼');
                } catch(err){
                    console.error(err);
                    alert('æ–‡ä»¶æ ¼å¼é”™è¯¯æˆ–æŸåï¼Œè¯·ä¸Šä¼ æ­£ç¡®çš„å¤‡ä»½æ–‡ä»¶ã€‚');
                } finally {
                    input.value = '';
                }
            };
            reader.readAsText(file);
        }

        /* =======================
           åˆå§‹åŒ–å¹¶å¯åŠ¨
           ======================= */
        init();

        // expose a minimal API for debugging in console (optional)
        window._FinanceApp = { financeData, updateUI, getMonthlySnapshot };

    })();
    </script>
</body>
</html>
