<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æˆ‘çš„è´¢åŠ¡æŠ¥è¡¨ Pro - å¹´åº¦å‡çº§ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- åŸºç¡€æ ·å¼ä¸iOSé€‚é… --- */
        :root {
            --ios-curve: cubic-bezier(0.25, 0.8, 0.25, 1);
            --ios-spring: cubic-bezier(0.175, 0.885, 0.32, 1.1);
        }
        
        /* ç¦æ­¢é•¿æŒ‰é€‰ä¸­æ–‡æœ¬ (Appè´¨æ„Ÿ) */
        * {
            -webkit-user-select: none; /* Safari / Chrome */
            user-select: none;
            -webkit-touch-callout: none; /* ç¦æ­¢iOSé•¿æŒ‰èœå• */
        }
        /* å…è®¸è¾“å…¥æ¡†å¯é€‰ä¸­ç¼–è¾‘ */
        input, textarea {
            -webkit-user-select: auto;
            user-select: auto;
        }

        html, body {
            -ms-overflow-style: none;
            scrollbar-width: none;
            min-height: 100vh;
            background-color: #F2F2F7; 
            -webkit-font-smoothing: antialiased;
        }
        ::-webkit-scrollbar { display: none; width: 0; height: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
            color: #1C1C1E;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* å¯¼èˆªæ é€‚é…ä¼˜åŒ–ï¼šå±…ä¸­å¯¹é½ï¼Œå¢åŠ é¡¶éƒ¨é—´è·é€‚é…åˆ˜æµ·å± */
        .glass-nav {
            position: fixed; top: 0; left: 0; right: 0; z-index: 50;
            background: rgba(242, 242, 247, 0.85);
            backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 0.5px solid rgba(0,0,0,0.1);
            /* å¢åŠ é¡¶éƒ¨ç•™ç™½ï¼Œä¼˜åŒ– 12 mini æ˜¾ç¤º */
            padding-top: calc(env(safe-area-inset-top) + 8px); 
            padding-bottom: 12px;
            transition: background 0.3s ease;
        }

        .date-trigger-wrapper { position: relative; display: inline-block; }
        .native-date-input {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; z-index: 10; cursor: pointer;
        }

        .ios-card-static { background: #FFFFFF; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .ios-card, .ios-clickable {
            background: #FFFFFF; border-radius: 16px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: transform 0.4s var(--ios-curve), background-color 0.2s ease, opacity 0.2s ease;
            will-change: transform;
        }
        .ios-card:active, .ios-clickable:active { 
            transform: scale(0.96); 
            opacity: 0.9;
        }

        #main-content { padding-top: calc(env(safe-area-inset-top) + 90px); }
        
        .modal-overlay { 
            transition: opacity 0.4s var(--ios-curve); 
            opacity: 0;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }
        .modal-enter .modal-overlay { opacity: 1; }
        
        .modal-content {
            transform: translateY(100%);
            transition: transform 0.5s var(--ios-spring);
        }
        .modal-enter .modal-content { transform: translateY(0); }
        
        @keyframes slideInUpFade {
            from { opacity: 0; transform: translateY(20px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .list-item-anim {
            animation: slideInUpFade 0.5s var(--ios-curve) forwards;
            opacity: 0; 
        }

        .sub-progress-bg { background-color: #E5E5EA; border-radius: 4px; height: 6px; overflow: hidden; }
        .sub-progress-fill { 
            height: 100%; border-radius: 4px; 
            width: 0%; 
            transition: width 1s var(--ios-curve);
        }
        
        .rank-bar-bg { background-color: #f3f4f6; height: 4px; border-radius: 2px; width: 100%; overflow: hidden; margin-top: 4px; }
        .rank-bar-fill { height: 100%; border-radius: 2px; width: 0%; transition: width 0.8s ease-out; }

        .btn-ios { transition: transform 0.2s, background-color 0.2s; }
        .btn-ios:active { transform: scale(0.97); }
    </style>
</head>
<body class="antialiased">

    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="glass-nav">
        <!-- æ”¹ä¸º items-center ç¡®ä¿å‚ç›´å±…ä¸­ -->
        <div class="px-5 flex justify-between items-center">
            <div class="date-trigger-wrapper btn-ios active:opacity-70">
                <p class="text-[10px] font-bold text-gray-500 uppercase tracking-wide mb-0.5">Total Balance</p>
                <div class="flex items-center gap-2">
                    <h1 class="text-2xl font-bold tracking-tight text-black" id="current-date">...</h1>
                    <div class="bg-gray-200/80 rounded-full h-5 w-5 flex items-center justify-center backdrop-blur-md">
                        <i class="fas fa-chevron-down text-[10px] text-gray-600"></i>
                    </div>
                </div>
                <input type="month" class="native-date-input" onchange="handleDateChange(this)">
            </div>
            <!-- å¹´æŠ¥å…¥å£ -->
            <button onclick="openAnnualReport()" class="h-8 px-3 bg-blue-500/10 text-blue-600 rounded-full flex items-center gap-1 text-xs font-bold active:bg-blue-500/20 active:scale-95 transition-all">
                <i class="fas fa-chart-pie"></i> å¹´æŠ¥
            </button>
        </div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div id="main-content" class="px-4 pb-24 space-y-5">
        
        <!-- æœ¬æœˆç»“ä½™å¡ç‰‡ -->
        <section>
            <div class="ios-card p-5 flex justify-between items-center relative overflow-hidden active:scale-[0.98] transition-transform duration-300">
                <div class="z-10">
                    <p class="text-sm font-medium text-gray-500 mb-1">æœ¬æœˆç»“ä½™ (Cash Flow)</p>
                    <p class="text-4xl font-bold text-black tracking-tight" id="cash-flow-display">Â¥0.00</p>
                </div>
                <div class="relative bg-blue-50 h-12 w-12 rounded-full flex items-center justify-center text-blue-500 shadow-sm z-20">
                    <i class="far fa-calendar-alt text-lg"></i>
                    <input type="month" class="native-date-input rounded-full" onchange="handleDateChange(this)">
                </div>
                <div class="absolute -right-6 -bottom-6 h-32 w-32 bg-blue-400/20 opacity-50 rounded-full blur-2xl pointer-events-none"></div>
            </div>
        </section>

        <!-- æ”¶æ”¯åˆ†æ -->
        <section>
            <h2 class="text-xs font-semibold text-gray-400 uppercase tracking-wider ml-4 mb-2">æ”¶æ”¯åˆ†æ</h2>
            <div class="ios-card-static p-0 overflow-hidden">
                <div class="grid grid-cols-2 divide-x divide-gray-100 border-b border-gray-100/50">
                    <div class="p-4 active:bg-gray-50 transition-colors cursor-pointer" onclick="showHistory('income')">
                        <div class="flex items-center gap-1 mb-2">
                            <div class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]"></div>
                            <span class="text-xs font-medium text-gray-500">æ€»æ”¶å…¥</span>
                        </div>
                        <p class="text-xl font-bold text-black" id="total-income">Â¥0</p>
                    </div>
                    <div class="p-4 active:bg-gray-50 transition-colors cursor-pointer" onclick="showHistory('expense')">
                        <div class="flex items-center gap-1 mb-2">
                            <div class="w-2 h-2 rounded-full bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.6)]"></div>
                            <span class="text-xs font-medium text-gray-500">æ€»æ”¯å‡º</span>
                        </div>
                        <p class="text-xl font-bold text-black" id="total-expense">Â¥0</p>
                    </div>
                </div>

                <div class="p-6 flex flex-col items-center justify-center relative border-b border-gray-100/50">
                    <div class="h-48 w-full relative z-10">
                        <canvas id="expenseChart"></canvas>
                    </div>
                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none mt-2">
                        <span class="text-xs text-gray-400 font-medium">æ”¯å‡ºåˆ†å¸ƒ</span>
                    </div>
                </div>

                <div id="expense-legend" class="p-4 space-y-4"></div>

                <div class="p-4 border-t border-gray-100/50">
                    <button onclick="openModal('transaction')" class="w-full bg-[#007AFF] active:bg-[#0063CC] text-white py-3.5 rounded-xl font-semibold text-[17px] shadow-lg shadow-blue-500/20 transition-all active:scale-[0.98] flex items-center justify-center gap-2">
                        <i class="fas fa-plus text-sm"></i> <span id="add-btn-text">è®°ä¸€ç¬”</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- èµ„äº§ç®¡ç† -->
        <section>
            <h2 class="text-xs font-semibold text-gray-400 uppercase tracking-wider ml-4 mb-2">èµ„äº§ç®¡ç†</h2>
            <div class="ios-card-static overflow-hidden">
                
                <div onclick="showHistory('asset')" class="p-4 border-b border-gray-100 active:bg-gray-50 transition-colors cursor-pointer">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <div class="bg-blue-100/80 p-1.5 rounded text-blue-600 text-xs"><i class="fas fa-wallet"></i></div>
                            <span class="text-sm font-bold text-gray-900">æ€»èµ„äº§</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-lg font-bold text-black" id="total-assets">Â¥0</span>
                            <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mt-3">
                        <div>
                            <div class="flex justify-between text-[10px] text-gray-500 mb-1">
                                <span>æµåŠ¨ (ç°é‡‘)</span>
                                <span id="val-asset-current">Â¥0</span>
                            </div>
                            <div class="sub-progress-bg"><div id="bar-asset-current" class="sub-progress-fill bg-blue-400" style="width:0%"></div></div>
                        </div>
                        <div>
                            <div class="flex justify-between text-[10px] text-gray-500 mb-1">
                                <span>éæµåŠ¨ (æˆ¿/è½¦)</span>
                                <span id="val-asset-fixed">Â¥0</span>
                            </div>
                            <div class="sub-progress-bg"><div id="bar-asset-fixed" class="sub-progress-fill bg-blue-800" style="width:0%"></div></div>
                        </div>
                    </div>
                </div>

                <div onclick="showHistory('liability')" class="p-4 border-b border-gray-100 active:bg-gray-50 transition-colors cursor-pointer">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <div class="bg-red-100/80 p-1.5 rounded text-red-500 text-xs"><i class="fas fa-credit-card"></i></div>
                            <span class="text-sm font-bold text-gray-900">æ€»è´Ÿå€º</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-lg font-bold text-black" id="total-liabilities">Â¥0</span>
                            <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mt-3">
                        <div>
                            <div class="flex justify-between text-[10px] text-gray-500 mb-1">
                                <span>çŸ­æœŸ (ä¿¡ç”¨å¡)</span>
                                <span id="val-debt-short">Â¥0</span>
                            </div>
                            <div class="sub-progress-bg"><div id="bar-debt-short" class="sub-progress-fill bg-red-400" style="width:0%"></div></div>
                        </div>
                        <div>
                            <div class="flex justify-between text-[10px] text-gray-500 mb-1">
                                <span>é•¿æœŸ (æˆ¿è´·)</span>
                                <span id="val-debt-long">Â¥0</span>
                            </div>
                            <div class="sub-progress-bg"><div id="bar-debt-long" class="sub-progress-fill bg-red-800" style="width:0%"></div></div>
                        </div>
                    </div>
                </div>

                <div class="p-4 bg-gray-50/50 flex justify-between items-center">
                    <span class="text-sm font-medium text-gray-500">å‡€èµ„äº§ (Net Worth)</span>
                    <span class="text-xl font-bold text-gray-900" id="net-worth">Â¥0</span>
                </div>

                <button onclick="openModal('asset_input')" class="w-full py-3 text-center text-[#007AFF] font-medium text-[15px] active:bg-gray-100 transition-colors border-t border-gray-100">
                    æ·»åŠ èµ„äº§æˆ–è´Ÿå€ºé¡¹ç›®
                </button>
            </div>
        </section>

        <!-- åº•éƒ¨åŠŸèƒ½ -->
        <section>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="exportData()" class="ios-card p-4 flex flex-col items-center justify-center gap-2 text-gray-600 active:scale-95 transition-transform">
                    <i class="fas fa-cloud-download-alt text-2xl text-blue-500"></i>
                    <span class="text-xs font-medium">å¤‡ä»½æ•°æ®</span>
                </button>
                <button onclick="document.getElementById('importFile').click()" class="ios-card p-4 flex flex-col items-center justify-center gap-2 text-gray-600 active:scale-95 transition-transform">
                    <i class="fas fa-cloud-upload-alt text-2xl text-green-500"></i>
                    <span class="text-xs font-medium">æ¢å¤æ•°æ®</span>
                </button>
                <input type="file" id="importFile" style="display:none" onchange="importData(this)">
            </div>
            <p class="text-center text-[10px] text-gray-400 mt-8 mb-4">Data stored locally on device</p>
        </section>
    </div>

    <!-- å¼¹çª—ï¼šå†å²è®°å½• -->
    <div id="modal-history" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 modal-overlay" onclick="closeModal('history')"></div>
        <div class="absolute bottom-0 w-full bg-[#F2F2F7] rounded-t-[28px] h-[85vh] flex flex-col modal-content shadow-2xl">
            <div class="w-full flex justify-center pt-3 pb-1" onclick="closeModal('history')">
                <div class="w-12 h-1.5 bg-gray-300 rounded-full opacity-50"></div>
            </div>
            <div class="px-5 py-3 flex justify-between items-center border-b border-gray-200/50 sticky top-0 z-10 bg-[#F2F2F7]/80 backdrop-blur-md rounded-t-[28px]">
                <h3 class="text-[22px] font-bold text-black" id="history-title">è®°å½•</h3>
                <button onclick="closeModal('history')" class="bg-gray-200/80 h-8 w-8 rounded-full flex items-center justify-center text-gray-500 font-bold active:scale-90 transition-transform"><i class="fas fa-times"></i></button>
            </div>
            <div id="history-list" class="flex-1 overflow-y-auto p-4 space-y-3" style="padding-bottom: calc(env(safe-area-inset-bottom) + 20px);">
                <!-- List Items go here -->
            </div>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šè®°è´¦ -->
    <div id="modal-transaction" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 modal-overlay" onclick="closeModal('transaction')"></div>
        <div class="absolute bottom-0 w-full bg-white rounded-t-[28px] p-6 pb-6 modal-content shadow-2xl" style="padding-bottom: calc(env(safe-area-inset-bottom) + 20px);">
            <div class="w-full flex justify-center -mt-2 mb-6">
                <div class="w-12 h-1.5 bg-gray-200 rounded-full opacity-50"></div>
            </div>
            
            <div class="space-y-6">
                <div class="flex bg-gray-100 p-1 rounded-xl">
                    <button onclick="setTransType('expense')" id="btn-expense" class="flex-1 py-2 rounded-lg text-[15px] font-medium shadow-sm bg-white text-black transition-all duration-300">æ”¯å‡º</button>
                    <button onclick="setTransType('income')" id="btn-income" class="flex-1 py-2 rounded-lg text-[15px] font-medium text-gray-500 transition-all duration-300">æ”¶å…¥</button>
                </div>

                <div id="expense-type-selector">
                    <label class="text-xs text-gray-400 font-medium ml-1 mb-1 block">æ”¯å‡ºæ€§è´¨</label>
                    <div class="flex gap-3">
                        <label class="flex-1 cursor-pointer group">
                            <input type="radio" name="expense_nature" value="variable" checked class="hidden peer" onchange="updateCategoryOptions('expense')">
                            <div class="py-2.5 text-center rounded-lg border border-gray-200 text-gray-500 peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-600 transition-all font-medium text-sm group-active:scale-[0.98]">
                                å³æ—¶/éå›ºå®š
                            </div>
                        </label>
                        <label class="flex-1 cursor-pointer group">
                            <input type="radio" name="expense_nature" value="fixed" class="hidden peer" onchange="updateCategoryOptions('expense')">
                            <div class="py-2.5 text-center rounded-lg border border-gray-200 text-gray-500 peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-600 transition-all font-medium text-sm group-active:scale-[0.98]">
                                å›ºå®šæ”¯å‡º (æˆ¿ç§Ÿç­‰)
                            </div>
                        </label>
                    </div>
                </div>
                
                <div>
                    <label class="text-xs text-gray-400 font-medium ml-1">é‡‘é¢</label>
                    <div class="relative mt-1">
                        <span class="absolute left-0 top-1/2 -translate-y-1/2 text-2xl font-bold text-black">Â¥</span>
                        <input type="number" id="t-amount" class="w-full pl-6 text-4xl font-bold border-b border-gray-100 py-2 outline-none text-black placeholder-gray-200 transition-colors focus:border-blue-500" placeholder="0.00">
                    </div>
                </div>

                <div>
                     <label class="text-xs text-gray-400 font-medium ml-1">åˆ†ç±»</label>
                    <div class="grid grid-cols-3 gap-3 mt-2">
                        <select id="t-category" class="col-span-3 bg-gray-50 text-lg rounded-xl px-4 py-3 outline-none appearance-none border border-gray-100 text-gray-700 font-medium focus:bg-white focus:border-blue-300 transition-all">
                        </select>
                    </div>
                </div>
                
                <button onclick="saveRecord('transaction')" class="w-full bg-black text-white py-4 rounded-2xl font-bold text-lg active:scale-[0.96] transition-transform shadow-lg shadow-black/10">ä¿å­˜è®°å½•</button>
            </div>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šèµ„äº§å½•å…¥ (å«ä¿®æ”¹æ¨¡å¼) -->
    <div id="modal-asset_input" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 modal-overlay" onclick="closeModal('asset_input')"></div>
        <div class="absolute bottom-0 w-full bg-white rounded-t-[28px] p-6 pb-6 modal-content shadow-2xl" style="padding-bottom: calc(env(safe-area-inset-bottom) + 20px);">
            <div class="w-full flex justify-center -mt-2 mb-6">
                <div class="w-12 h-1.5 bg-gray-200 rounded-full opacity-50"></div>
            </div>
            
            <div class="space-y-5">
                <h3 class="text-xl font-bold text-center" id="asset-modal-title">èµ„äº§/è´Ÿå€ºå½•å…¥</h3>
                
                <!-- ç±»å‹åˆ‡æ¢ (ä¿®æ”¹æ¨¡å¼ä¸‹ç¦ç”¨) -->
                <div class="flex bg-gray-100 p-1 rounded-xl" id="asset-type-switch">
                    <button onclick="setAssetType('asset')" id="btn-asset" class="flex-1 py-2 rounded-lg text-[15px] font-medium shadow-sm bg-white text-black transition-all">èµ„äº§</button>
                    <button onclick="setAssetType('liability')" id="btn-liability" class="flex-1 py-2 rounded-lg text-[15px] font-medium text-gray-500 transition-all">è´Ÿå€º</button>
                </div>

                <div>
                    <label class="text-xs text-gray-400 font-medium ml-1 mb-1 block">ç±»å‹æ€§è´¨</label>
                    <div class="flex gap-3">
                        <label class="flex-1 cursor-pointer group">
                            <input type="radio" name="asset_subtype" value="type1" checked class="hidden peer">
                            <div class="py-2.5 text-center rounded-lg border border-gray-200 text-gray-500 peer-checked:border-blue-500 peer-checked:bg-blue-50 peer-checked:text-blue-600 transition-all font-medium text-sm group-active:scale-[0.98]" id="subtype-label-1">
                                æµåŠ¨èµ„äº§
                            </div>
                        </label>
                        <label class="flex-1 cursor-pointer group">
                            <input type="radio" name="asset_subtype" value="type2" class="hidden peer">
                            <div class="py-2.5 text-center rounded-lg border border-gray-200 text-gray-500 peer-checked:border-blue-500 peer-checked:bg-blue-50 peer-checked:text-blue-600 transition-all font-medium text-sm group-active:scale-[0.98]" id="subtype-label-2">
                                éæµåŠ¨èµ„äº§
                            </div>
                        </label>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-xl p-4 border border-gray-100 focus-within:bg-white focus-within:border-blue-200 transition-colors">
                    <input type="text" id="a-name" class="w-full bg-transparent outline-none text-lg font-medium placeholder-gray-400" placeholder="é¡¹ç›®åç§° (å¦‚: æ‹›è¡Œå¡/æˆ¿è´·)">
                </div>

                <div class="bg-gray-50 rounded-xl p-4 border border-gray-100 flex items-center focus-within:bg-white focus-within:border-blue-200 transition-colors">
                    <span class="text-xl font-bold text-gray-400 mr-2">Â¥</span>
                    <input type="number" id="a-amount" class="w-full bg-transparent outline-none text-2xl font-bold text-black placeholder-gray-300" placeholder="0.00">
                </div>

                <button onclick="saveRecord('asset')" class="w-full bg-[#007AFF] text-white py-4 rounded-2xl font-bold text-lg active:scale-[0.96] transition-transform shadow-lg shadow-blue-500/20" id="btn-save-asset">ç¡®è®¤ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šå¹´åº¦æŠ¥å‘Š -->
    <div id="modal-annual" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-white modal-overlay overflow-y-auto opacity-100">
            <div class="p-5" style="padding-bottom: calc(env(safe-area-inset-bottom) + 20px);">
                <!-- Header -->
                <div class="flex justify-between items-center mb-6 pt-2 sticky top-0 bg-white/90 backdrop-blur z-10 py-2">
                    <button onclick="closeModal('annual')" class="h-8 w-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 active:scale-90 transition-transform">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h2 class="text-lg font-bold">å¹´åº¦è´¢åŠ¡æŠ¥å‘Š</h2>
                    <div class="w-8"></div>
                </div>

                <!-- å¹´ä»½åˆ‡æ¢ -->
                <div class="flex justify-center mb-6">
                    <div class="bg-gray-100 p-1 rounded-xl flex items-center shadow-inner">
                        <button onclick="changeReportYear(-1)" class="w-10 h-8 flex items-center justify-center text-gray-500 active:scale-90 transition-transform"><i class="fas fa-chevron-left"></i></button>
                        <span class="px-4 font-bold text-lg tabular-nums" id="report-year-display">2026</span>
                        <button onclick="changeReportYear(1)" class="w-10 h-8 flex items-center justify-center text-gray-500 active:scale-90 transition-transform"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>

                <!-- èµ„äº§å˜åŠ¨æƒ…å†µ (æ±‡æ€») -->
                <div class="animate-fade-in-up" style="animation-delay: 0.1s;">
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3 ml-1">èµ„äº§å˜åŠ¨ (å¹´åˆ vs å¹´æœ«)</h3>
                    <div class="grid grid-cols-2 gap-3 mb-6">
                        <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                            <p class="text-xs font-bold text-blue-600 mb-2 flex items-center gap-1"><i class="fas fa-wallet"></i> æ€»èµ„äº§</p>
                            <div class="flex justify-between text-sm text-gray-600 mb-1">
                                <span>å¹´åˆ</span>
                                <span class="font-bold text-black" id="annual-asset-start">Â¥0</span>
                            </div>
                            <div class="flex justify-between text-sm text-gray-600">
                                <span>å¹´æœ«</span>
                                <span class="font-bold text-black" id="annual-asset-end">Â¥0</span>
                            </div>
                        </div>
                        <div class="bg-red-50 p-4 rounded-2xl border border-red-100">
                            <p class="text-xs font-bold text-red-600 mb-2 flex items-center gap-1"><i class="fas fa-credit-card"></i> æ€»è´Ÿå€º</p>
                            <div class="flex justify-between text-sm text-gray-600 mb-1">
                                <span>å¹´åˆ</span>
                                <span class="font-bold text-black" id="annual-debt-start">Â¥0</span>
                            </div>
                            <div class="flex justify-between text-sm text-gray-600">
                                <span>å¹´æœ«</span>
                                <span class="font-bold text-black" id="annual-debt-end">Â¥0</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- èµ„äº§å˜åŠ¨æƒ…å†µ (æ˜ç»†) -->
                <div class="animate-fade-in-up mb-6" style="animation-delay: 0.15s;">
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-2 ml-1">èµ„äº§è´Ÿå€ºæ˜ç»†è¡¨</h3>
                    <div class="bg-white rounded-xl border border-gray-100 overflow-hidden" id="annual-asset-detail-list">
                        <!-- JS å¡«å…… -->
                    </div>
                </div>

                <!-- å¹´åº¦æ€»è§ˆ -->
                <div class="animate-fade-in-up" style="animation-delay: 0.2s;">
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3 ml-1">æ”¶æ”¯æ¦‚è§ˆ</h3>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="bg-green-50 p-4 rounded-2xl border border-green-100">
                            <p class="text-xs text-green-600 mb-1">å¹´åº¦æ€»æ”¶å…¥</p>
                            <p class="text-xl font-bold text-green-700" id="annual-income">Â¥0</p>
                        </div>
                        <div class="bg-red-50 p-4 rounded-2xl border border-red-100">
                            <p class="text-xs text-red-600 mb-1">å¹´åº¦æ€»æ”¯å‡º</p>
                            <p class="text-xl font-bold text-red-700" id="annual-expense">Â¥0</p>
                        </div>
                    </div>
                    
                    <div class="bg-gray-100 p-4 rounded-2xl mb-8 flex justify-between items-center shadow-inner">
                        <div>
                            <p class="text-xs text-gray-600 mb-1">å¹´åº¦ç»“ä½™</p>
                            <p class="text-2xl font-bold text-black" id="annual-balance">Â¥0</p>
                        </div>
                        <i class="fas fa-piggy-bank text-3xl text-gray-300"></i>
                    </div>
                </div>

                <!-- 12ä¸ªæœˆè¶‹åŠ¿å›¾ -->
                <div class="animate-fade-in-up" style="animation-delay: 0.3s;">
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4 ml-1">æœˆåº¦æ”¶æ”¯è¶‹åŠ¿</h3>
                    <div class="bg-white rounded-2xl border border-gray-100 p-4 mb-8 shadow-sm h-64">
                        <canvas id="annualChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- é€»è¾‘å±‚ ---
        let financeData = { records: [] };
        let viewDate = new Date(); 
        let currentTransType = 'expense';
        let currentAssetType = 'asset';
        let expenseChartInstance = null;
        let annualChartInstance = null;
        let reportYear = new Date().getFullYear();

        const categories = {
            expense_variable: [
                {val: 'é¤é¥®', label: 'ğŸ” é¤é¥®ç¾é£Ÿ'}, {val: 'äº¤é€š', label: 'ğŸš— äº¤é€šå‡ºè¡Œ'},
                {val: 'è´­ç‰©', label: 'ğŸ›ï¸ è´­ç‰©æ¶ˆè´¹'}, {val: 'æ°´ç”µæ°”', label: 'âš¡ æ°´ç”µæ°”'},
                {val: 'å¨±ä¹', label: 'ğŸ® ä¼‘é—²å¨±ä¹'}, {val: 'åŒ»ç–—', label: 'ğŸ’Š åŒ»ç–—å¥åº·'},
                {val: 'å…¶ä»–', label: 'ğŸ“ å…¶ä»–æ”¯å‡º'}
            ],
            expense_fixed: [
                {val: 'æˆ¿ç§Ÿ', label: 'ğŸ  æˆ¿ç§Ÿ'}, {val: 'ç‰©ä¸šè´¹', label: 'ğŸ¢ ç‰©ä¸šè´¹'},
                {val: 'æˆ¿è´·', label: 'ğŸ¦ æˆ¿è´·'}, {val: 'ä¸ªäººè´·æ¬¾', label: 'ğŸ’³ ä¸ªäººè´·æ¬¾ (çŸ­æœŸ)'},
                {val: 'æ±½è½¦è´·æ¬¾', label: 'ğŸš˜ æ±½è½¦è´·æ¬¾'}
            ],
            income: [
                {val: 'å·¥èµ„', label: 'ğŸ’° å·¥èµ„æ”¶å…¥'}, {val: 'ç†è´¢', label: 'ğŸ“ˆ æŠ•èµ„ç†è´¢'},
                {val: 'å…¶ä»–', label: 'ğŸ“ å…¶ä»–æ”¶å…¥'}
            ]
        };

        window.onload = function() {
            const savedData = localStorage.getItem('myFinanceData_v6'); 
            if (savedData) financeData = JSON.parse(savedData);
            updateCategoryOptions('expense');
            updateUI();
        };

        function handleDateChange(input) {
            if(input.value) {
                const parts = input.value.split('-');
                viewDate = new Date(parts[0], parts[1] - 1, 1);
                updateUI();
            }
        }

        // --- æ ¸å¿ƒé€»è¾‘ï¼šè·å–æŸæœˆèµ„äº§å¿«ç…§ ---
        // è¿”å›ï¼š{ 'æ‹›è¡Œå¡': {amount: 1000, type: 'asset', subtype: 'current', recordId: '123' or null} }
        function getMonthlySnapshot(year, month) {
            // 1. æ‰¾å‡ºæ‰€æœ‰å‡ºç°è¿‡çš„èµ„äº§åç§°
            const allNames = new Set();
            financeData.records.forEach(r => {
                if(r.type === 'asset' || r.type === 'liability') allNames.add(r.name);
            });

            // 2. é’ˆå¯¹æ¯ä¸ªåå­—ï¼Œæ‰¾è¯¥æœˆä»½åŠä¹‹å‰çš„æœ€åä¸€æ¡è®°å½•
            const snapshot = {};
            const targetTime = new Date(year, month + 1, 0, 23, 59, 59).getTime(); // æœˆæœ«

            allNames.forEach(name => {
                // æ‰¾åˆ°è¯¥åå­—æ‰€æœ‰è®°å½•ï¼ŒæŒ‰æ—¶é—´å€’åº
                const history = financeData.records
                    .filter(r => r.name === name)
                    .filter(r => new Date(r.date).getTime() <= targetTime)
                    .sort((a,b) => new Date(b.date) - new Date(a.date));

                if(history.length > 0) {
                    const latest = history[0];
                    // æ£€æŸ¥æœ€æ–°è¿™æ¡è®°å½•æ˜¯å¦æ­£å¥½æ˜¯å½“å‰é€‰ä¸­æœˆä»½çš„
                    const rDate = new Date(latest.date);
                    const isCurrentMonth = (rDate.getFullYear() === year && rDate.getMonth() === month);
                    
                    snapshot[name] = {
                        amount: parseFloat(latest.amount),
                        type: latest.type,
                        subtype: latest.subtype,
                        recordId: isCurrentMonth ? latest.id : null, // åªæœ‰æœ¬æœˆæœ‰æ˜¾å¼è®°å½•æ‰æœ‰ID
                        date: latest.date
                    };
                }
            });
            return snapshot;
        }

        function updateUI() {
            const vYear = viewDate.getFullYear();
            const vMonth = viewDate.getMonth();
            
            // æ—¥æœŸæ˜¾ç¤º
            document.getElementById('current-date').innerText = `${vYear}å¹´${vMonth + 1}æœˆ`;
            const dateStr = `${vYear}-${(vMonth + 1).toString().padStart(2, '0')}`;
            document.querySelectorAll('.native-date-input').forEach(input => input.value = dateStr);

            // 1. è®¡ç®—æ”¶æ”¯ (Flow)
            let totalInc = 0, totalExp = 0;
            let catExp = {};
            
            financeData.records.forEach(r => {
                if(r.type === 'income' || r.type === 'expense') {
                    const d = new Date(r.date);
                    if(d.getFullYear() === vYear && d.getMonth() === vMonth) {
                        const amt = parseFloat(r.amount);
                        if(r.type === 'income') totalInc += amt;
                        else {
                            totalExp += amt;
                            catExp[r.category] = (catExp[r.category] || 0) + amt;
                        }
                    }
                }
            });

            // 2. è®¡ç®—èµ„äº§è´Ÿå€º (Snapshot)
            let snapshot = getMonthlySnapshot(vYear, vMonth);
            let totals = { asset: 0, liability: 0, assetCurrent: 0, assetFixed: 0, debtShort: 0, debtLong: 0 };
            
            Object.values(snapshot).forEach(item => {
                const amt = item.amount;
                if(item.type === 'asset') {
                    totals.asset += amt;
                    if(item.subtype === 'current') totals.assetCurrent += amt; else totals.assetFixed += amt;
                } else {
                    totals.liability += amt;
                    if(item.subtype === 'short') totals.debtShort += amt; else totals.debtLong += amt;
                }
            });

            // æ›´æ–°DOM
            const today = new Date();
            if (vYear === today.getFullYear() && vMonth === today.getMonth()) {
                document.getElementById('add-btn-text').innerText = "è®°ä¸€ç¬”";
            } else {
                document.getElementById('add-btn-text').innerText = `è¡¥å½• ${vMonth+1}æœˆè´¦ç›®`;
            }

            document.getElementById('total-income').innerText = `Â¥${totalInc.toFixed(2)}`;
            document.getElementById('total-expense').innerText = `Â¥${totalExp.toFixed(2)}`;
            const cashFlow = totalInc - totalExp;
            const flowEl = document.getElementById('cash-flow-display');
            flowEl.innerText = `Â¥${cashFlow.toFixed(2)}`;
            flowEl.className = `text-4xl font-bold tracking-tight ${cashFlow >= 0 ? 'text-black' : 'text-red-500'}`;

            document.getElementById('total-assets').innerText = `Â¥${totals.asset.toLocaleString()}`;
            document.getElementById('total-liabilities').innerText = `Â¥${totals.liability.toLocaleString()}`;
            document.getElementById('net-worth').innerText = `Â¥${(totals.asset - totals.liability).toLocaleString()}`;
            
            document.getElementById('val-asset-current').innerText = `Â¥${totals.assetCurrent.toLocaleString()}`;
            document.getElementById('val-asset-fixed').innerText = `Â¥${totals.assetFixed.toLocaleString()}`;
            document.getElementById('val-debt-short').innerText = `Â¥${totals.debtShort.toLocaleString()}`;
            document.getElementById('val-debt-long').innerText = `Â¥${totals.debtLong.toLocaleString()}`;

            requestAnimationFrame(() => {
                const maxAsset = Math.max(totals.asset, 1);
                const maxDebt = Math.max(totals.liability, 1);
                document.getElementById('bar-asset-current').style.width = `${(totals.assetCurrent / maxAsset)*100}%`;
                document.getElementById('bar-asset-fixed').style.width = `${(totals.assetFixed / maxAsset)*100}%`;
                document.getElementById('bar-debt-short').style.width = `${(totals.debtShort / maxDebt)*100}%`;
                document.getElementById('bar-debt-long').style.width = `${(totals.debtLong / maxDebt)*100}%`;
            });

            updateChartAndList(catExp, totalExp);
            localStorage.setItem('myFinanceData_v6', JSON.stringify(financeData));
        }

        // --- èµ„äº§å¼¹çª—ç¼–è¾‘é€»è¾‘ ---
        function openAssetEdit(name, amount, type, subtype) {
            // æ‰“å¼€å¼¹çª—å¹¶é¢„å¡«ä¿¡æ¯
            openModal('asset_input');
            document.getElementById('asset-modal-title').innerText = "ä¿®æ”¹èµ„äº§/è´Ÿå€ºçŠ¶æ€";
            document.getElementById('a-name').value = name;
            document.getElementById('a-name').disabled = true; // ä¿®æ”¹æ¨¡å¼ä¸‹åå­—ä¸å¯å˜ï¼Œå˜äº†å°±æ˜¯æ–°å¢
            document.getElementById('a-amount').value = amount;
            
            // é”å®šç±»å‹
            setAssetType(type);
            document.getElementById('asset-type-switch').classList.add('opacity-50', 'pointer-events-none');
            
            // é”å®šå­ç±»å‹
            const radios = document.getElementsByName('asset_subtype');
            if(type === 'asset') {
                radios[0].checked = (subtype === 'current');
                radios[1].checked = (subtype !== 'current');
            } else {
                radios[0].checked = (subtype === 'short');
                radios[1].checked = (subtype !== 'short');
            }
        }

        // --- å†å²/åˆ—è¡¨é€»è¾‘ ---
        function showHistory(type) {
            const titles = { income: 'æ”¶å…¥æ˜ç»†', expense: 'æ”¯å‡ºæ˜ç»†', asset: 'æœ¬æœˆèµ„äº§æ¸…å•', liability: 'æœ¬æœˆè´Ÿå€ºæ¸…å•' };
            document.getElementById('history-title').innerText = titles[type];
            const listEl = document.getElementById('history-list');
            listEl.innerHTML = '';

            const vYear = viewDate.getFullYear();
            const vMonth = viewDate.getMonth();

            if (type === 'income' || type === 'expense') {
                // æ”¶æ”¯æ˜¾ç¤ºæµæ°´
                const filtered = financeData.records.filter(r => {
                    const rDate = new Date(r.date);
                    return r.type === type && rDate.getFullYear() === vYear && rDate.getMonth() === vMonth;
                });
                renderTransactionList(listEl, filtered, type);
            } else {
                // èµ„äº§è´Ÿå€ºæ˜¾ç¤ºå¿«ç…§
                const snapshot = getMonthlySnapshot(vYear, vMonth);
                const items = [];
                Object.keys(snapshot).forEach(name => {
                    const item = snapshot[name];
                    if (item.type === type) {
                        items.push({ name: name, ...item });
                    }
                });
                renderAssetSnapshotList(listEl, items, type);
            }
            openModal('history');
        }

        function renderTransactionList(container, records, type) {
            if (records.length === 0) {
                container.innerHTML = `<div class="flex flex-col items-center justify-center mt-20 opacity-50"><p class="text-sm text-gray-400">æœ¬æœˆæš‚æ— è®°å½•</p></div>`;
                return;
            }
            records.reverse().forEach((r, index) => {
                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm mb-2 list-item-anim";
                div.style.animationDelay = `${index * 0.05}s`;
                
                let subLabel = "";
                if(r.type === 'expense' && r.expenseType === 'fixed') subLabel = ' <span class="text-[10px] border border-red-200 text-red-500 px-1.5 py-0.5 rounded ml-1">å›ºå®š</span>';

                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="h-10 w-10 rounded-full ${type==='income' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-500'} flex items-center justify-center text-sm">
                            <i class="fas ${getIcon(r.category)}"></i>
                        </div>
                        <div>
                            <p class="font-bold text-gray-900 text-[15px]">${r.category} ${subLabel}</p>
                            <p class="text-xs text-gray-400 mt-0.5">${r.date.split('T')[0]}</p>
                        </div>
                    </div>
                    <div class="text-right">
                         <p class="font-bold text-lg ${type==='income'?'text-green-600':'text-black'}">${type==='income'?'+':'-'}Â¥${parseFloat(r.amount).toLocaleString()}</p>
                         <button onclick="deleteRecord('${r.id}', '${type}')" class="text-xs text-red-400 mt-1 px-2 py-1 active:bg-red-50 rounded transition-colors">åˆ é™¤</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function renderAssetSnapshotList(container, items, type) {
            if (items.length === 0) {
                container.innerHTML = `<div class="flex flex-col items-center justify-center mt-20 opacity-50"><p class="text-sm text-gray-400">æœ¬æœˆæ— ${type === 'asset' ? 'èµ„äº§' : 'è´Ÿå€º'}é¡¹ç›®</p></div>`;
                return;
            }
            items.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm mb-2 list-item-anim active:scale-[0.98] transition-transform cursor-pointer";
                div.style.animationDelay = `${index * 0.05}s`;
                
                // ç‚¹å‡»ç›´æ¥ç¼–è¾‘
                div.onclick = function() {
                    closeModal('history');
                    setTimeout(() => {
                        openAssetEdit(item.name, item.amount, type, item.subtype);
                    }, 300);
                };

                let subLabel = "";
                if(type === 'asset') subLabel = (item.subtype === 'fixed') ? 'éæµåŠ¨' : 'æµåŠ¨';
                else subLabel = (item.subtype === 'long') ? 'é•¿æœŸ' : 'çŸ­æœŸ';
                
                // æ ‡è®°æ˜¯å¦æ˜¯â€œç»§æ‰¿â€çš„æ•°æ®
                const isInherited = item.recordId === null;

                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="h-10 w-10 rounded-full ${type==='asset' ? 'bg-blue-100 text-blue-600' : 'bg-red-100 text-red-500'} flex items-center justify-center text-sm">
                            <i class="fas ${type==='asset' ? 'fa-wallet' : 'fa-credit-card'}"></i>
                        </div>
                        <div>
                            <p class="font-bold text-gray-900 text-[15px]">${item.name}</p>
                            <p class="text-xs text-gray-400 mt-0.5 bg-gray-100 inline-block px-1.5 rounded">${subLabel}</p>
                            ${isInherited ? '<span class="text-[10px] text-gray-400 ml-1">(ç»§æ‰¿ä¸Šæœˆ)</span>' : '<span class="text-[10px] text-blue-500 ml-1">(æœ¬æœˆå·²å½•å…¥)</span>'}
                        </div>
                    </div>
                    <div class="text-right">
                         <p class="font-bold text-lg text-black">Â¥${item.amount.toLocaleString()}</p>
                         <p class="text-xs text-blue-500 mt-1">ä¿®æ”¹</p>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // --- ä¿å­˜é€»è¾‘ ---
        function saveRecord(mode) {
            // æ„é€ æœ¬æœˆçš„æ—¶é—´æˆ³
            let recordDate = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1, 12, 0, 0);
            
            // å¦‚æœæ˜¯ä»Šå¤©æ‰€åœ¨çš„æœˆä»½ï¼Œç”¨å½“å‰æ—¶é—´ï¼ˆä¸ºäº†æ’åºå¥½çœ‹ï¼‰
            const now = new Date();
            if (now.getFullYear() === viewDate.getFullYear() && now.getMonth() === viewDate.getMonth()) {
                recordDate = now;
            }

            if (mode === 'transaction') {
                const amt = document.getElementById('t-amount').value;
                if (!amt) return alert('è¯·å¡«å†™é‡‘é¢');
                const record = { 
                    id: Date.now().toString(), 
                    date: recordDate.toISOString(),
                    type: currentTransType,
                    amount: amt,
                    category: document.getElementById('t-category').value
                };
                
                if(currentTransType === 'expense') {
                    const radios = document.getElementsByName('expense_nature');
                    let nVal = 'variable';
                    for(let r of radios) { if(r.checked) nVal = r.value; }
                    record.expenseType = nVal;
                }
                financeData.records.push(record);
                document.getElementById('t-amount').value = '';
                closeModal('transaction');
            } 
            else { // Asset / Liability (å¿«ç…§æ¨¡å¼)
                const amt = document.getElementById('a-amount').value;
                const name = document.getElementById('a-name').value;
                if (!amt || !name) return alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                
                const radios = document.getElementsByName('asset_subtype');
                let subVal = 'type1';
                for(let r of radios) { if(r.checked) subVal = r.value; }

                // æ ¸å¿ƒé€»è¾‘ï¼šæ£€æŸ¥æœ¬æœˆæ˜¯å¦å·²ç»å­˜åœ¨è¯¥èµ„äº§çš„è®°å½•
                // 1. æŸ¥æ‰¾æœ¬æœˆæ˜¯å¦å·²æœ‰è¯¥åå­—çš„è®°å½•
                const vYear = viewDate.getFullYear();
                const vMonth = viewDate.getMonth();
                
                let existingIndex = -1;
                for(let i=0; i<financeData.records.length; i++) {
                    const r = financeData.records[i];
                    if (r.name === name && (r.type === 'asset' || r.type === 'liability')) {
                        const rDate = new Date(r.date);
                        if(rDate.getFullYear() === vYear && rDate.getMonth() === vMonth) {
                            existingIndex = i;
                            break;
                        }
                    }
                }

                const newRecord = {
                    id: (existingIndex !== -1) ? financeData.records[existingIndex].id : Date.now().toString(),
                    date: recordDate.toISOString(),
                    type: currentAssetType,
                    amount: amt,
                    name: name,
                    subtype: (currentAssetType === 'asset') ? ((subVal === 'type1') ? 'current' : 'fixed') : ((subVal === 'type1') ? 'short' : 'long')
                };

                if (existingIndex !== -1) {
                    // æ›´æ–°æœ¬æœˆè®°å½• (Copy-on-write æ•ˆæœï¼Œå®é™…ä¸Šæ˜¯ Update-in-place for this month)
                    financeData.records[existingIndex] = newRecord;
                } else {
                    // æ–°å¢æœ¬æœˆè®°å½• (ä¸å½±å“ä»¥å‰çš„)
                    financeData.records.push(newRecord);
                }

                document.getElementById('a-amount').value = '';
                document.getElementById('a-name').value = '';
                closeModal('asset_input');
            }
            updateUI();
        }

        function deleteRecord(id, type) {
            if (confirm('âš ï¸ ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
                financeData.records = financeData.records.filter(r => r.id !== id);
                updateUI();
                // é‡æ–°åˆ·æ–°åˆ—è¡¨
                if(!document.getElementById('modal-history').classList.contains('hidden')){
                    showHistory(type);
                }
            }
        }

        // --- Annual Report ---
        function updateAnnualReport() {
            document.getElementById('report-year-display').innerText = reportYear;
            
            // 1. æ”¶æ”¯ç»Ÿè®¡ (Flow)
            let monthlyData = Array.from({length: 12}, () => ({inc: 0, exp: 0}));
            let yTotalInc = 0, yTotalExp = 0;
            
            financeData.records.forEach(r => {
                if(r.type === 'income' || r.type === 'expense') {
                    const d = new Date(r.date);
                    if(d.getFullYear() === reportYear) {
                        const amt = parseFloat(r.amount);
                        if(r.type === 'income') { monthlyData[d.getMonth()].inc += amt; yTotalInc += amt; } 
                        else { monthlyData[d.getMonth()].exp += amt; yTotalExp += amt; }
                    }
                }
            });

            // 2. èµ„äº§å˜åŠ¨ (Snapshot Start vs End)
            // å¹´åˆï¼šä¸Šä¸€å¹´12æœˆçš„æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå–å½“å¹´1æœˆçš„æ•°æ®å‰æ¨
            // ç®€å•èµ·è§ï¼Œå–å½“å¹´1æœˆçš„å¿«ç…§ vs å½“å¹´12æœˆ(æˆ–å½“å‰æœˆ)çš„å¿«ç…§
            
            const startSnapshot = getMonthlySnapshot(reportYear, 0); // 1æœˆ
            
            // å¦‚æœæ˜¯å½“å‰å¹´ä»½ï¼Œå–å½“å‰æœˆä½œä¸º"å¹´æœ«"ï¼Œå¦åˆ™å–12æœˆ
            const now = new Date();
            let endMonth = 11;
            if(reportYear === now.getFullYear()) endMonth = now.getMonth();
            const endSnapshot = getMonthlySnapshot(reportYear, endMonth);

            let sAsset = 0, sDebt = 0;
            Object.values(startSnapshot).forEach(v => {
                if(v.type === 'asset') sAsset += v.amount; else sDebt += v.amount;
            });
            
            let eAsset = 0, eDebt = 0;
            Object.values(endSnapshot).forEach(v => {
                if(v.type === 'asset') eAsset += v.amount; else eDebt += v.amount;
            });

            // å¡«å……æ±‡æ€»
            document.getElementById('annual-income').innerText = `Â¥${yTotalInc.toLocaleString()}`;
            document.getElementById('annual-expense').innerText = `Â¥${yTotalExp.toLocaleString()}`;
            document.getElementById('annual-balance').innerText = `Â¥${(yTotalInc - yTotalExp).toLocaleString()}`;
            document.getElementById('annual-asset-start').innerText = `Â¥${sAsset.toLocaleString()}`;
            document.getElementById('annual-asset-end').innerText = `Â¥${eAsset.toLocaleString()}`;
            document.getElementById('annual-debt-start').innerText = `Â¥${sDebt.toLocaleString()}`;
            document.getElementById('annual-debt-end').innerText = `Â¥${eDebt.toLocaleString()}`;

            // å¡«å……èµ„äº§æ˜ç»†åˆ—è¡¨
            const detailList = document.getElementById('annual-asset-detail-list');
            detailList.innerHTML = '';
            
            // åˆå¹¶æ‰€æœ‰å‡ºç°è¿‡çš„åå­—
            const allReportNames = new Set([...Object.keys(startSnapshot), ...Object.keys(endSnapshot)]);
            
            if(allReportNames.size === 0) {
                 detailList.innerHTML = '<div class="p-4 text-center text-gray-400 text-xs">æš‚æ— èµ„äº§æ•°æ®</div>';
            } else {
                // æ’åºï¼šèµ„äº§åœ¨å‰ï¼Œè´Ÿå€ºåœ¨å
                const sortedNames = Array.from(allReportNames).sort((a,b) => {
                    const typeA = (endSnapshot[a] || startSnapshot[a]).type;
                    const typeB = (endSnapshot[b] || startSnapshot[b]).type;
                    if(typeA !== typeB) return typeA === 'asset' ? -1 : 1;
                    return 0;
                });

                sortedNames.forEach(name => {
                    const startVal = startSnapshot[name] ? startSnapshot[name].amount : 0;
                    const endVal = endSnapshot[name] ? endSnapshot[name].amount : 0;
                    const info = endSnapshot[name] || startSnapshot[name]; // è·å–ç±»å‹ä¿¡æ¯
                    const diff = endVal - startVal;
                    
                    const div = document.createElement('div');
                    div.className = "flex justify-between items-center p-3 border-b border-gray-100 last:border-0 text-sm";
                    div.innerHTML = `
                        <div>
                            <span class="${info.type === 'asset' ? 'text-blue-600 bg-blue-50' : 'text-red-500 bg-red-50'} text-[10px] px-1 rounded mr-1">${info.type==='asset'?'èµ„':'å€º'}</span>
                            <span class="font-medium text-gray-700">${name}</span>
                        </div>
                        <div class="flex gap-4 text-right">
                             <div class="flex flex-col">
                                <span class="text-[10px] text-gray-400">å¹´åˆ</span>
                                <span class="text-gray-500">Â¥${startVal.toLocaleString()}</span>
                             </div>
                             <div class="flex flex-col">
                                <span class="text-[10px] text-gray-400">å¹´æœ«</span>
                                <span class="font-bold text-black">Â¥${endVal.toLocaleString()}</span>
                             </div>
                        </div>
                    `;
                    detailList.appendChild(div);
                });
            }

            // Chart
            const ctx = document.getElementById('annualChart').getContext('2d');
            if (annualChartInstance) annualChartInstance.destroy();

            annualChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'],
                    datasets: [
                        { label: 'æ”¶å…¥', data: monthlyData.map(d => d.inc), backgroundColor: '#34C759', borderRadius: 4, barPercentage: 0.6 },
                        { label: 'æ”¯å‡º', data: monthlyData.map(d => d.exp), backgroundColor: '#FF3B30', borderRadius: 4, barPercentage: 0.6 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { grid: { display: false } }, y: { display: false } },
                    plugins: { legend: { position: 'top', align: 'end' } }
                }
            });
        }

        // --- Utils & Others ---
        function updateChartAndList(data, totalExp) {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            const legendContainer = document.getElementById('expense-legend');
            if (expenseChartInstance) expenseChartInstance.destroy();
            
            const isEmpty = Object.keys(data).length === 0;
            const displayData = isEmpty ? { "æ— ": 1 } : data;
            
            const colorMap = {
                'é¤é¥®': '#FF3B30', 'äº¤é€š': '#007AFF', 'è´­ç‰©': '#FF9500', 'æ°´ç”µæ°”': '#AF52DE', 
                'å¨±ä¹': '#5856D6', 'åŒ»ç–—': '#FF2D55', 'å…¶ä»–': '#8E8E93', 'æˆ¿ç§Ÿ': '#FF9F0A', 
                'ç‰©ä¸šè´¹': '#FFD60A', 'æˆ¿è´·': '#AC8E68', 'ä¸ªäººè´·æ¬¾': '#FF453A', 'æ±½è½¦è´·æ¬¾': '#30B0C7', 'æ— ': '#F2F2F7'
            };
            
            expenseChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(displayData),
                    datasets: [{ data: Object.values(displayData), backgroundColor: Object.keys(displayData).map(l => colorMap[l]||'#8E8E93'), borderWidth: 0 }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, cutout: '75%',
                    plugins: { legend: { display: false }, tooltip: { enabled: !isEmpty } }
                }
            });

            legendContainer.innerHTML = '';
            if(!isEmpty) {
                Object.entries(data).sort((a,b) => b[1] - a[1]).forEach(([cat, amount], index) => {
                    const percent = ((amount / totalExp) * 100).toFixed(1);
                    const color = colorMap[cat] || '#8E8E93';
                    const div = document.createElement('div');
                    div.style.animation = `slideInUpFade 0.6s cubic-bezier(0.25, 0.8, 0.25, 1) forwards`;
                    div.style.opacity = '0';
                    div.style.animationDelay = `${index * 0.05}s`;
                    div.innerHTML = `
                        <div class="flex items-center justify-between text-sm mb-1">
                            <div class="flex items-center gap-2"><i class="fas ${getIcon(cat)} w-5 text-center" style="color:${color}"></i><span class="font-medium text-gray-700">${cat}</span></div>
                            <div class="flex items-center gap-3"><span class="text-xs font-bold text-gray-400">${percent}%</span><span class="font-bold text-gray-900">Â¥${amount.toLocaleString()}</span></div>
                        </div>
                        <div class="rank-bar-bg"><div class="rank-bar-fill" style="width: ${percent}%; background-color: ${color}"></div></div>
                    `;
                    legendContainer.appendChild(div);
                });
            } else {
                legendContainer.innerHTML = '<p class="text-center text-xs text-gray-400 py-2">æœ¬æœˆæš‚æ— æ”¯å‡ºè®°å½•</p>';
            }
        }

        function getIcon(c) {
            const map = { 'é¤é¥®':'fa-utensils', 'äº¤é€š':'fa-car', 'è´­ç‰©':'fa-shopping-bag', 'æ°´ç”µæ°”':'fa-bolt', 'å¨±ä¹':'fa-gamepad', 'åŒ»ç–—':'fa-briefcase-medical', 'å…¶ä»–':'fa-sticky-note', 'å·¥èµ„':'fa-coins', 'ç†è´¢':'fa-chart-line', 'æˆ¿ç§Ÿ':'fa-house-user', 'ç‰©ä¸šè´¹':'fa-building', 'æˆ¿è´·':'fa-file-invoice-dollar', 'ä¸ªäººè´·æ¬¾':'fa-credit-card', 'æ±½è½¦è´·æ¬¾':'fa-car-side' };
            return map[c] || 'fa-tag';
        }

        function openModal(t) { const m = document.getElementById(`modal-${t}`); m.classList.remove('hidden'); void m.offsetWidth; m.classList.add('modal-enter'); }
        function closeModal(t) { const m = document.getElementById(`modal-${t}`); m.classList.remove('modal-enter'); setTimeout(() => m.classList.add('hidden'), 350); }
        function openAnnualReport() { reportYear = new Date().getFullYear(); updateAnnualReport(); openModal('annual'); }
        function changeReportYear(d) { reportYear += d; updateAnnualReport(); }
        
        function setTransType(t) {
            currentTransType = t;
            const a = "flex-1 py-2 rounded-lg text-[15px] font-medium shadow-sm bg-white text-black transition-all duration-300";
            const i = "flex-1 py-2 rounded-lg text-[15px] font-medium text-gray-500 transition-all duration-300";
            document.getElementById('btn-expense').className = t==='expense'?a:i;
            document.getElementById('btn-income').className = t==='income'?a:i;
            document.getElementById('expense-type-selector').classList.toggle('hidden', t!=='expense');
            updateCategoryOptions(t);
        }

        function updateCategoryOptions(type) {
            const select = document.getElementById('t-category'); select.innerHTML = '';
            let list = [];
            if (type === 'income') list = categories.income;
            else {
                const radios = document.getElementsByName('expense_nature');
                let isFixed = false; for(let r of radios) { if(r.checked && r.value === 'fixed') isFixed = true; }
                list = isFixed ? categories.expense_fixed : categories.expense_variable;
            }
            list.forEach(c => { const o = document.createElement('option'); o.value = c.val; o.innerText = c.label; select.appendChild(o); });
        }

        function setAssetType(t) {
            currentAssetType = t;
            const a = "flex-1 py-2 rounded-lg text-[15px] font-medium shadow-sm bg-white text-black transition-all";
            const i = "flex-1 py-2 rounded-lg text-[15px] font-medium text-gray-500 transition-all";
            document.getElementById('btn-asset').className = t==='asset'?a:i;
            document.getElementById('btn-liability').className = t==='liability'?a:i;
            document.getElementById('subtype-label-1').innerText = t==='asset' ? "æµåŠ¨èµ„äº§ (ç°é‡‘)" : "çŸ­æœŸè´Ÿå€º (<1å¹´)";
            document.getElementById('subtype-label-2').innerText = t==='asset' ? "éæµåŠ¨èµ„äº§ (æˆ¿è½¦)" : "é•¿æœŸè´Ÿå€º (>1å¹´)";
        }
        
        // Reset Modal State when closing
        document.getElementById('modal-asset_input').addEventListener('transitionend', function(e) {
             if(this.classList.contains('hidden')) {
                 // Reset to Create Mode
                 document.getElementById('asset-modal-title').innerText = "èµ„äº§/è´Ÿå€ºå½•å…¥";
                 document.getElementById('a-name').value = '';
                 document.getElementById('a-name').disabled = false;
                 document.getElementById('a-amount').value = '';
                 document.getElementById('asset-type-switch').classList.remove('opacity-50', 'pointer-events-none');
             }
        });

        function exportData() {
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(JSON.stringify(financeData));
            const a = document.createElement('a'); a.href = dataUri; a.download = `FinPro_${new Date().toISOString().slice(0,10)}.json`; a.click();
        }
        function importData(input) {
            const reader = new FileReader();
            reader.onload = e => { try { financeData = JSON.parse(e.target.result); updateUI(); alert('æ¢å¤æˆåŠŸ'); } catch(err) { alert('æ–‡ä»¶é”™è¯¯'); } };
            reader.readAsText(input.files[0]);
        }
    </script>
</body>
</html>