<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- å…³é”®ï¼šviewport-fit=cover ç¡®ä¿é¡µé¢å……æ»¡å…¨å±ï¼ŒåŒ…æ‹¬åˆ˜æµ·åŒºåŸŸ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æˆ‘çš„è´¢åŠ¡æŠ¥è¡¨ Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- 1. å½»åº•éšè—æ»šåŠ¨æ¡ --- */
        html, body {
            -ms-overflow-style: none;
            scrollbar-width: none;
            min-height: 100vh;
            /* ä¿®å¤ iOS Safari æ©¡çš®ç­‹å›å¼¹éœ²ç™½é—®é¢˜ */
            background-color: #F2F2F7; 
        }
        ::-webkit-scrollbar {
            display: none;
            width: 0;
            height: 0;
        }

        /* iOS å­—ä½“ä¼˜åŒ– */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
            color: #1C1C1E;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* --- 2. é¡¶éƒ¨å¯¼èˆªæ é€‚é…ä¿®å¤ (iPhone 12 Mini) --- */
        .glass-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 50;
            background: rgba(242, 242, 247, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 0.5px solid rgba(0,0,0,0.1);
            
            /* å…³é”®ä¿®å¤ï¼šåˆ©ç”¨ padding-top æŠŠå†…å®¹é¡¶ä¸‹æ¥ï¼Œé¿å¼€åˆ˜æµ· */
            /* env(safe-area-inset-top) è·å–åˆ˜æµ·é«˜åº¦ï¼Œé¢å¤–åŠ  10px å¢åŠ å‘¼å¸æ„Ÿ */
            padding-top: calc(env(safe-area-inset-top) + 12px);
            padding-bottom: 12px;
        }

        /* --- 3. æ—¥æœŸé€‰æ‹©å™¨ä¿®å¤ (é€æ˜è¦†ç›–å±‚æ³•) --- */
        .date-trigger-wrapper {
            position: relative; /* å»ºç«‹å®šä½åŸºå‡† */
            display: inline-block;
        }
        
        /* è¿™ä¸ªè¾“å…¥æ¡†ä¼šç›–åœ¨æ–‡å­—ä¸Šé¢ï¼Œé€æ˜ï¼Œç”¨æˆ·ç‚¹æ–‡å­—å…¶å®æ˜¯ç‚¹åˆ°äº†å®ƒ */
        .native-date-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0; /* å®Œå…¨é€æ˜ */
            z-index: 10; /* ç¡®ä¿åœ¨æ–‡å­—ä¸Šå±‚ */
            cursor: pointer;
        }

        /* å¡ç‰‡æ ·å¼ */
        .ios-card-static {
            background: #FFFFFF;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .ios-card {
            background: #FFFFFF;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: transform 0.1s;
        }
        .ios-card:active { transform: scale(0.98); }

        /* å†…å®¹åŒºåŸŸçš„é¡¶éƒ¨é¿è®© */
        #main-content {
            /* è¿™é‡Œçš„ 110px æ˜¯ä¼°ç®—çš„ Header é«˜åº¦ï¼Œç¡®ä¿å†…å®¹ä¸è¢« Header é®æŒ¡ */
            /* iOS ä¸Šåˆ˜æµ·é«˜åº¦çº¦ä¸º 44-50pxï¼ŒåŠ ä¸Šå†…å®¹çš„ padding */
            padding-top: calc(env(safe-area-inset-top) + 100px);
        }
        
        /* å¼¹çª—åŠ¨ç”» */
        .modal-enter { animation: slideUp 0.35s cubic-bezier(0.32, 0.72, 0, 1) forwards; }
        .modal-overlay { transition: opacity 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body class="antialiased">

    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="glass-nav">
        <div class="px-5 flex justify-between items-end">
            <!-- å·¦ä¾§ï¼šæ—¥æœŸé€‰æ‹©åŒº -->
            <!-- ä¿®å¤é€»è¾‘ï¼šrelative çˆ¶å®¹å™¨åŒ…è£¹æ–‡å­—å’Œé€æ˜ input -->
            <div class="date-trigger-wrapper">
                <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Total Balance</p>
                <div class="flex items-center gap-2">
                    <h1 class="text-3xl font-bold tracking-tight text-black" id="current-date">...</h1>
                    <div class="bg-gray-200 rounded-full h-6 w-6 flex items-center justify-center">
                        <i class="fas fa-chevron-down text-[10px] text-gray-600"></i>
                    </div>
                </div>
                <!-- çœŸæ­£çš„ Inputï¼Œé€æ˜è¦†ç›–åœ¨ä¸Šæ–¹ -->
                <input type="month" class="native-date-input" onchange="handleDateChange(this)">
            </div>
            
            <!-- å³ä¾§å¯ä»¥æ”¾å¤´åƒæˆ–è®¾ç½®ï¼Œå ä½ä¿æŒå¸ƒå±€å¹³è¡¡ -->
            <div class="h-8 w-8"></div> 
        </div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div id="main-content" class="px-4 pb-24 space-y-6">
        
        <!-- æœ¬æœˆç»“ä½™å¡ç‰‡ -->
        <section>
            <div class="ios-card-static p-5 flex justify-between items-center relative overflow-hidden">
                <div class="z-10">
                    <p class="text-sm font-medium text-gray-500 mb-1">æœ¬æœˆç»“ä½™ (Cash Flow)</p>
                    <p class="text-4xl font-bold text-black tracking-tight" id="cash-flow-display">Â¥0.00</p>
                </div>
                
                <!-- è¿™ä¸ªå›¾æ ‡æŒ‰é’®ä¹Ÿå¯ä»¥åŠ ä¸Šæ—¥æœŸé€‰æ‹©åŠŸèƒ½ï¼ŒåŒæ ·çš„é€æ˜è¦†ç›–æ³• -->
                <div class="relative bg-blue-50 h-12 w-12 rounded-full flex items-center justify-center text-blue-500 shadow-sm z-20">
                    <i class="far fa-calendar-alt text-lg"></i>
                    <input type="month" class="native-date-input rounded-full" onchange="handleDateChange(this)">
                </div>
                
                <div class="absolute -right-6 -bottom-6 h-24 w-24 bg-blue-400 opacity-5 rounded-full blur-xl"></div>
            </div>
        </section>

        <!-- æ”¶æ”¯åˆ†æ -->
        <section>
            <h2 class="text-xs font-semibold text-gray-400 uppercase tracking-wider ml-4 mb-2">æ”¶æ”¯åˆ†æ</h2>
            <div class="ios-card-static p-0">
                <div class="grid grid-cols-2 divide-x divide-gray-100 border-b border-gray-100">
                    <div class="p-4 active:bg-gray-50 transition-colors" onclick="showHistory('income')">
                        <div class="flex items-center gap-1 mb-2">
                            <div class="w-2 h-2 rounded-full bg-green-500"></div>
                            <span class="text-xs font-medium text-gray-500">æ€»æ”¶å…¥</span>
                        </div>
                        <p class="text-xl font-bold text-black" id="total-income">Â¥0</p>
                    </div>
                    <div class="p-4 active:bg-gray-50 transition-colors" onclick="showHistory('expense')">
                        <div class="flex items-center gap-1 mb-2">
                            <div class="w-2 h-2 rounded-full bg-red-500"></div>
                            <span class="text-xs font-medium text-gray-500">æ€»æ”¯å‡º</span>
                        </div>
                        <p class="text-xl font-bold text-black" id="total-expense">Â¥0</p>
                    </div>
                </div>

                <div class="p-6 flex flex-col items-center justify-center relative">
                    <div class="h-48 w-full relative z-10">
                        <canvas id="expenseChart"></canvas>
                    </div>
                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none mt-2">
                        <span class="text-xs text-gray-400 font-medium">æ”¯å‡ºåˆ†å¸ƒ</span>
                    </div>
                </div>

                <div class="p-4 border-t border-gray-100">
                    <button onclick="openModal('transaction')" class="w-full bg-[#007AFF] hover:bg-[#0063CC] active:bg-[#0055B3] text-white py-3.5 rounded-xl font-semibold text-[17px] shadow-lg shadow-blue-500/30 transition-all flex items-center justify-center gap-2">
                        <i class="fas fa-plus text-sm"></i> <span id="add-btn-text">è®°ä¸€ç¬”</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- èµ„äº§ç®¡ç† -->
        <section>
            <h2 class="text-xs font-semibold text-gray-400 uppercase tracking-wider ml-4 mb-2">èµ„äº§ç®¡ç†</h2>
            <div class="ios-card-static overflow-hidden">
                <div onclick="showHistory('asset')" class="p-4 flex items-center justify-between border-b border-gray-100 active:bg-gray-50 transition-colors">
                    <div class="flex items-center gap-3">
                        <div class="bg-blue-100 p-2 rounded-lg text-blue-600"><i class="fas fa-wallet"></i></div>
                        <div>
                            <p class="text-sm font-medium text-gray-900">æ€»èµ„äº§</p>
                            <div class="w-24 h-1.5 bg-gray-100 rounded-full mt-1.5 overflow-hidden">
                                <div class="bg-blue-500 h-full rounded-full" style="width: 100%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-lg font-bold text-black" id="total-assets">Â¥0</span>
                        <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
                    </div>
                </div>

                <div onclick="showHistory('liability')" class="p-4 flex items-center justify-between border-b border-gray-100 active:bg-gray-50 transition-colors">
                    <div class="flex items-center gap-3">
                        <div class="bg-red-100 p-2 rounded-lg text-red-500"><i class="fas fa-credit-card"></i></div>
                        <div>
                            <p class="text-sm font-medium text-gray-900">æ€»è´Ÿå€º</p>
                            <div class="w-24 h-1.5 bg-gray-100 rounded-full mt-1.5 overflow-hidden">
                                <div id="liability-bar" class="bg-red-500 h-full rounded-full progress-bar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-lg font-bold text-black" id="total-liabilities">Â¥0</span>
                        <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
                    </div>
                </div>

                <div class="p-4 bg-gray-50 flex justify-between items-center">
                    <span class="text-sm font-medium text-gray-500">å‡€èµ„äº§ (Net Worth)</span>
                    <span class="text-xl font-bold text-gray-900" id="net-worth">Â¥0</span>
                </div>

                <button onclick="openModal('asset_input')" class="w-full py-3 text-center text-[#007AFF] font-medium text-[15px] active:bg-gray-100 transition-colors border-t border-gray-100">
                    æ·»åŠ èµ„äº§æˆ–è´Ÿå€ºé¡¹ç›®
                </button>
            </div>
        </section>

        <!-- åº•éƒ¨åŠŸèƒ½ -->
        <section>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="exportData()" class="ios-card p-4 flex flex-col items-center justify-center gap-2 text-gray-600 active:scale-95 transition-transform">
                    <i class="fas fa-cloud-download-alt text-2xl text-blue-500"></i>
                    <span class="text-xs font-medium">å¤‡ä»½æ•°æ®</span>
                </button>
                <button onclick="document.getElementById('importFile').click()" class="ios-card p-4 flex flex-col items-center justify-center gap-2 text-gray-600 active:scale-95 transition-transform">
                    <i class="fas fa-cloud-upload-alt text-2xl text-green-500"></i>
                    <span class="text-xs font-medium">æ¢å¤æ•°æ®</span>
                </button>
                <input type="file" id="importFile" style="display:none" onchange="importData(this)">
            </div>
            <p class="text-center text-[10px] text-gray-400 mt-6 mb-4">Data stored locally on device</p>
        </section>
    </div>

    <!-- å¼¹çª—ï¼šå†å²è®°å½• -->
    <div id="modal-history" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-[2px] modal-overlay" onclick="closeModal('history')"></div>
        <div class="absolute bottom-0 w-full bg-[#F2F2F7] rounded-t-[24px] h-[85vh] flex flex-col modal-enter shadow-2xl">
            <div class="w-full flex justify-center pt-3 pb-1" onclick="closeModal('history')">
                <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
            </div>
            <div class="px-5 py-3 flex justify-between items-center bg-[#F2F2F7] border-b border-gray-200/50">
                <h3 class="text-[22px] font-bold text-black" id="history-title">è®°å½•</h3>
                <button onclick="closeModal('history')" class="bg-gray-200 h-8 w-8 rounded-full flex items-center justify-center text-gray-500 font-bold"><i class="fas fa-times"></i></button>
            </div>
            <div id="history-list" class="flex-1 overflow-y-auto p-4 space-y-3" style="padding-bottom: calc(env(safe-area-inset-bottom) + 20px);">
            </div>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šè®°è´¦ -->
    <div id="modal-transaction" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-[2px] modal-overlay" onclick="closeModal('transaction')"></div>
        <div class="absolute bottom-0 w-full bg-white rounded-t-[24px] p-6 pb-6 modal-enter shadow-2xl" style="padding-bottom: calc(env(safe-area-inset-bottom) + 20px);">
            <div class="w-full flex justify-center -mt-2 mb-6">
                <div class="w-12 h-1.5 bg-gray-200 rounded-full"></div>
            </div>
            
            <div class="space-y-6">
                <div class="flex bg-gray-100 p-1 rounded-xl">
                    <button onclick="setTransType('expense')" id="btn-expense" class="flex-1 py-2 rounded-lg text-[15px] font-medium shadow-sm bg-white text-black transition-all">æ”¯å‡º</button>
                    <button onclick="setTransType('income')" id="btn-income" class="flex-1 py-2 rounded-lg text-[15px] font-medium text-gray-500 transition-all">æ”¶å…¥</button>
                </div>
                
                <div>
                    <label class="text-xs text-gray-400 font-medium ml-1">é‡‘é¢</label>
                    <div class="relative">
                        <span class="absolute left-0 top-1/2 -translate-y-1/2 text-2xl font-bold text-black">Â¥</span>
                        <input type="number" id="t-amount" class="w-full pl-6 text-4xl font-bold border-b border-gray-100 py-2 outline-none text-black placeholder-gray-200" placeholder="0.00">
                    </div>
                </div>

                <div>
                     <label class="text-xs text-gray-400 font-medium ml-1">åˆ†ç±»</label>
                    <div class="grid grid-cols-3 gap-3 mt-2">
                        <select id="t-category" class="col-span-3 bg-gray-50 text-lg rounded-xl px-4 py-3 outline-none appearance-none border border-gray-100 text-gray-700 font-medium">
                            <option value="é¤é¥®">ğŸ” é¤é¥®ç¾é£Ÿ</option>
                            <option value="äº¤é€š">ğŸš— äº¤é€šå‡ºè¡Œ</option>
                            <option value="è´­ç‰©">ğŸ›ï¸ è´­ç‰©æ¶ˆè´¹</option>
                            <option value="å±…ä½">ğŸ  å±…ä½ç¼´è´¹</option>
                            <option value="å¨±ä¹">ğŸ® ä¼‘é—²å¨±ä¹</option>
                            <option value="åŒ»ç–—">ğŸ’Š åŒ»ç–—å¥åº·</option>
                            <option value="å·¥èµ„">ğŸ’° å·¥èµ„æ”¶å…¥</option>
                            <option value="ç†è´¢">ğŸ“ˆ æŠ•èµ„ç†è´¢</option>
                            <option value="å…¶ä»–">ğŸ“ å…¶ä»–</option>
                        </select>
                    </div>
                </div>
                
                <button onclick="saveRecord('transaction')" class="w-full bg-black text-white py-4 rounded-2xl font-bold text-lg active:scale-[0.98] transition-transform">ä¿å­˜è®°å½•</button>
            </div>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šèµ„äº§ -->
    <div id="modal-asset_input" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-[2px] modal-overlay" onclick="closeModal('asset_input')"></div>
        <div class="absolute bottom-0 w-full bg-white rounded-t-[24px] p-6 pb-6 modal-enter shadow-2xl" style="padding-bottom: calc(env(safe-area-inset-bottom) + 20px);">
            <div class="w-full flex justify-center -mt-2 mb-6">
                <div class="w-12 h-1.5 bg-gray-200 rounded-full"></div>
            </div>
            
            <div class="space-y-5">
                <h3 class="text-xl font-bold text-center">æ–°å¢é¡¹ç›®</h3>
                
                <div class="flex bg-gray-100 p-1 rounded-xl">
                    <button onclick="setAssetType('asset')" id="btn-asset" class="flex-1 py-2 rounded-lg text-[15px] font-medium shadow-sm bg-white text-black transition-all">èµ„äº§</button>
                    <button onclick="setAssetType('liability')" id="btn-liability" class="flex-1 py-2 rounded-lg text-[15px] font-medium text-gray-500 transition-all">è´Ÿå€º</button>
                </div>

                <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
                    <input type="text" id="a-name" class="w-full bg-transparent outline-none text-lg font-medium placeholder-gray-400" placeholder="é¡¹ç›®åç§° (å¦‚: æ‹›è¡Œå‚¨è“„å¡)">
                </div>

                <div class="bg-gray-50 rounded-xl p-4 border border-gray-100 flex items-center">
                    <span class="text-xl font-bold text-gray-400 mr-2">Â¥</span>
                    <input type="number" id="a-amount" class="w-full bg-transparent outline-none text-2xl font-bold text-black placeholder-gray-300" placeholder="0.00">
                </div>

                <button onclick="saveRecord('asset')" class="w-full bg-[#007AFF] text-white py-4 rounded-2xl font-bold text-lg active:scale-[0.98] transition-transform">ç¡®è®¤æ·»åŠ </button>
            </div>
        </div>
    </div>

    <script>
        // --- é€»è¾‘å±‚ ---
        let financeData = { records: [] };
        let viewDate = new Date(); 
        let currentTransType = 'expense';
        let currentAssetType = 'asset';
        let expenseChartInstance = null;

        window.onload = function() {
            const savedData = localStorage.getItem('myFinanceData_v2');
            if (savedData) financeData = JSON.parse(savedData);
            
            updateUI();
        };

        // ç§»é™¤åŸæœ‰çš„ openDatePicker å‡½æ•°ï¼Œå› ä¸ºç°åœ¨æ˜¯åŸç”Ÿç‚¹å‡»
        function handleDateChange(input) {
            if(input.value) {
                const parts = input.value.split('-');
                viewDate = new Date(parts[0], parts[1] - 1, 1);
                updateUI();
            }
        }

        function updateUI() {
            let totals = { income: 0, expense: 0, asset: 0, liability: 0 };
            let catExp = {};
            const vYear = viewDate.getFullYear();
            const vMonth = viewDate.getMonth();

            document.getElementById('current-date').innerText = `${vYear}å¹´${vMonth + 1}æœˆ`;

            // åŒæ­¥éšè—çš„æ—¥æœŸ Input çš„å€¼ï¼Œç¡®ä¿ä¸‹æ¬¡æ‰“å¼€æ˜¯å½“å‰é€‰ä¸­çš„æœˆä»½
            // æ³¨æ„ï¼šSafari å¯èƒ½éœ€è¦è¿™ä¸ªå€¼æ¥é«˜äº®å½“å‰é€‰ä¸­çš„æœˆä»½
            const dateStr = `${vYear}-${(vMonth + 1).toString().padStart(2, '0')}`;
            const dateInputs = document.querySelectorAll('.native-date-input');
            dateInputs.forEach(input => input.value = dateStr);

            const today = new Date();
            if (vYear === today.getFullYear() && vMonth === today.getMonth()) {
                document.getElementById('add-btn-text').innerText = "è®°ä¸€ç¬”";
            } else {
                document.getElementById('add-btn-text').innerText = `è¡¥å½• ${vMonth+1}æœˆè´¦ç›®`;
            }

            financeData.records.forEach(r => {
                const rDate = new Date(r.date);
                if (r.type === 'income' || r.type === 'expense') {
                    if (rDate.getFullYear() === vYear && rDate.getMonth() === vMonth) {
                        totals[r.type] += parseFloat(r.amount);
                        if (r.type === 'expense') {
                            catExp[r.category] = (catExp[r.category] || 0) + parseFloat(r.amount);
                        }
                    }
                } else {
                    totals[r.type] += parseFloat(r.amount);
                }
            });

            document.getElementById('total-income').innerText = `Â¥${totals.income.toFixed(2)}`;
            document.getElementById('total-expense').innerText = `Â¥${totals.expense.toFixed(2)}`;
            document.getElementById('total-assets').innerText = `Â¥${totals.asset.toLocaleString()}`;
            document.getElementById('total-liabilities').innerText = `Â¥${totals.liability.toLocaleString()}`;
            
            const cashFlow = totals.income - totals.expense;
            const flowEl = document.getElementById('cash-flow-display');
            flowEl.innerText = `Â¥${cashFlow.toFixed(2)}`;
            flowEl.className = `text-4xl font-bold tracking-tight ${cashFlow >= 0 ? 'text-black' : 'text-red-500'}`;

            const netWorth = totals.asset - totals.liability;
            document.getElementById('net-worth').innerText = `Â¥${netWorth.toLocaleString()}`;
            
            const maxVal = Math.max(totals.asset, totals.liability, 1);
            document.getElementById('liability-bar').style.width = `${(totals.liability / maxVal) * 100}%`;

            updateChart(catExp);
            localStorage.setItem('myFinanceData_v2', JSON.stringify(financeData));
        }

        function updateChart(data) {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            if (expenseChartInstance) expenseChartInstance.destroy();
            
            const isEmpty = Object.keys(data).length === 0;
            const displayData = isEmpty ? { "æ— ": 1 } : data;
            const displayColors = isEmpty 
                ? ['#F2F2F7'] 
                : ['#FF3B30', '#007AFF', '#FFCC00', '#34C759', '#5856D6', '#AF52DE', '#FF9500', '#5AC8FA'];

            expenseChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(displayData),
                    datasets: [{ 
                        data: Object.values(displayData), 
                        backgroundColor: displayColors, 
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { display: false },
                        tooltip: { enabled: !isEmpty }
                    }, 
                    cutout: '75%',
                    animation: { animateScale: true, animateRotate: true }
                }
            });
        }

        function showHistory(type) {
            const titles = { income: 'æ”¶å…¥æ˜ç»†', expense: 'æ”¯å‡ºæ˜ç»†', asset: 'èµ„äº§åˆ—è¡¨', liability: 'è´Ÿå€ºåˆ—è¡¨' };
            const vYear = viewDate.getFullYear();
            const vMonth = viewDate.getMonth();

            document.getElementById('history-title').innerText = titles[type];
            const listEl = document.getElementById('history-list');
            listEl.innerHTML = '';

            const filtered = financeData.records.filter(r => {
                if (r.type !== type) return false;
                if (type === 'income' || type === 'expense') {
                    const rDate = new Date(r.date);
                    return rDate.getFullYear() === vYear && rDate.getMonth() === vMonth;
                }
                return true;
            });

            if (filtered.length === 0) {
                listEl.innerHTML = `
                    <div class="flex flex-col items-center justify-center mt-20 opacity-50">
                        <i class="fas fa-folder-open text-4xl mb-3 text-gray-300"></i>
                        <p class="text-sm text-gray-400">æš‚æ— ç›¸å…³è®°å½•</p>
                    </div>`;
            } else {
                filtered.reverse().forEach(r => {
                    const div = document.createElement('div');
                    div.className = "bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm mb-2";
                    
                    const isPositive = r.type==='income'||r.type==='asset';
                    const sign = r.type==='income' ? '+' : (r.type==='expense' ? '-' : '');
                    
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="h-10 w-10 rounded-full ${isPositive ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-500'} flex items-center justify-center text-sm">
                                <i class="fas ${getIcon(r.category)}"></i>
                            </div>
                            <div>
                                <p class="font-bold text-gray-900 text-[15px]">${r.category || r.name}</p>
                                <p class="text-xs text-gray-400 mt-0.5">${r.date.split('T')[0]}</p>
                            </div>
                        </div>
                        <div class="text-right">
                             <p class="font-bold text-lg ${isPositive?'text-green-600':'text-black'}">${sign}Â¥${parseFloat(r.amount).toLocaleString()}</p>
                             <button onclick="deleteRecord('${r.id}', '${type}')" class="text-xs text-red-400 mt-1 px-2 py-1 active:bg-red-50 rounded">åˆ é™¤</button>
                        </div>
                    `;
                    listEl.appendChild(div);
                });
            }
            openModal('history');
        }

        function getIcon(category) {
            const map = {
                'é¤é¥®': 'fa-utensils', 'äº¤é€š': 'fa-car', 'è´­ç‰©': 'fa-shopping-bag',
                'å±…ä½': 'fa-home', 'å·¥èµ„': 'fa-coins', 'å…¶ä»–': 'fa-sticky-note',
                'å¨±ä¹': 'fa-gamepad', 'åŒ»ç–—': 'fa-briefcase-medical', 'ç†è´¢': 'fa-chart-line'
            };
            return map[category] || 'fa-tag';
        }

        function deleteRecord(id, type) {
            if (confirm('âš ï¸ ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ\næ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) {
                financeData.records = financeData.records.filter(r => r.id !== id);
                updateUI();
                showHistory(type); 
            }
        }

        function saveRecord(mode) {
            let recordDate = new Date();
            if (recordDate.getMonth() !== viewDate.getMonth() || recordDate.getFullYear() !== viewDate.getFullYear()) {
                recordDate = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1, 12, 0, 0);
            }

            let record = { id: Date.now().toString(), date: recordDate.toISOString() };
            
            if (mode === 'transaction') {
                const amt = document.getElementById('t-amount').value;
                if (!amt) return alert('è¯·å¡«å†™é‡‘é¢');
                record.type = currentTransType;
                record.amount = amt;
                record.category = document.getElementById('t-category').value;
                document.getElementById('t-amount').value = '';
                closeModal('transaction');
            } else {
                const amt = document.getElementById('a-amount').value;
                const name = document.getElementById('a-name').value;
                if (!amt || !name) return alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                record.type = currentAssetType;
                record.amount = amt;
                record.name = name;
                document.getElementById('a-amount').value = '';
                document.getElementById('a-name').value = '';
                closeModal('asset_input');
            }
            financeData.records.push(record);
            updateUI();
        }

        function openModal(t) { document.getElementById(`modal-${t}`).classList.remove('hidden'); }
        function closeModal(t) { document.getElementById(`modal-${t}`).classList.add('hidden'); }

        function setTransType(t) {
            currentTransType = t;
            const activeClass = "flex-1 py-2 rounded-lg text-[15px] font-medium shadow-sm bg-white text-black transition-all";
            const inactiveClass = "flex-1 py-2 rounded-lg text-[15px] font-medium text-gray-500 transition-all";
            document.getElementById('btn-expense').className = t==='expense'?activeClass:inactiveClass;
            document.getElementById('btn-income').className = t==='income'?activeClass:inactiveClass;
        }

        function setAssetType(t) {
            currentAssetType = t;
            const activeClass = "flex-1 py-2 rounded-lg text-[15px] font-medium shadow-sm bg-white text-black transition-all";
            const inactiveClass = "flex-1 py-2 rounded-lg text-[15px] font-medium text-gray-500 transition-all";
            document.getElementById('btn-asset').className = t==='asset'?activeClass:inactiveClass;
            document.getElementById('btn-liability').className = t==='liability'?activeClass:inactiveClass;
        }

        function exportData() {
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(JSON.stringify(financeData));
            const a = document.createElement('a');
            a.setAttribute('href', dataUri);
            a.setAttribute('download', `FinPro_Backup_${new Date().toISOString().slice(0,10)}.json`);
            a.click();
        }

        function importData(input) {
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    financeData = JSON.parse(e.target.result);
                    updateUI();
                    alert('æ•°æ®æ¢å¤æˆåŠŸï¼');
                } catch(err) {
                    alert('æ–‡ä»¶æ ¼å¼é”™è¯¯');
                }
            };
            reader.readAsText(input.files[0]);
        }
    </script>
</body>
</html>