<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„è´¢åŠ¡æŠ¥è¡¨ Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            /* ä½¿ç”¨æ›´ç°ä»£çš„å­—ä½“æ ˆ */
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "San Francisco", "Helvetica Neue", Roboto, sans-serif;
            background-color: #F5F7FA; /*ç¨å¾®äº®ä¸€ç‚¹çš„èƒŒæ™¯ç°*/
            -webkit-tap-highlight-color: transparent;
        }
        /* é€šç”¨ç»ç’ƒå¡ç‰‡æ ·å¼ (ç”¨äºä¸‹æ–¹çš„å¡ç‰‡) */
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        }
        /* --- æ–°å¢ï¼šé¡¶éƒ¨è‹±é›„å¡ç‰‡ä¸“å±æ ·å¼ --- */
        .hero-card-bg {
            background: linear-gradient(135deg, #ffffff 0%, #f0f7ff 100%);
            box-shadow: 0 10px 30px -10px rgba(37, 99, 235, 0.2); /* è“è‰²ç³»çš„æŠ•å½± */
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        html, body { height: 100%; overflow: hidden; }
        /* ä¸»å†…å®¹åŒºåŸŸè°ƒæ•´äº†é¡¶éƒ¨å†…è¾¹è·ï¼Œå› ä¸ºå»æ‰äº†ç²˜æ€§æ ‡é¢˜æ  */
        #main-content { height: 100%; overflow-y: auto; padding-bottom: 100px; }
        
        /* åˆ—è¡¨æ»‘å‡ºåŠ¨ç”» */
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        /* éšè—åŸç”Ÿæ—¥å†è¾“å…¥æ¡† */
        #date-picker-input { visibility: hidden; position: absolute; top: 0; left: 0; width: 0; height: 0; }
    </style>
</head>
<body class="text-gray-800">

    <input type="month" id="date-picker-input" onchange="handleDateChange(this)">

    <div id="main-content">
        <div class="pt-12 px-5 pb-6 bg-gradient-to-b from-blue-50/80 to-transparent">
            <div class="flex justify-between items-center mb-6">
                 <div>
                    <p class="text-sm text-gray-500 font-medium tracking-wider uppercase">Dashboard</p>
                    <h1 class="text-3xl font-extrabold tracking-tight text-gray-900">è´¢åŠ¡æ¦‚è§ˆ</h1>
                 </div>
                 <button onclick="openDatePicker()" class="bg-white pl-4 pr-3 py-2 rounded-full text-blue-600 font-bold shadow-sm border border-blue-100 flex items-center gap-2 active:scale-95 transition-transform">
                     <span id="current-date-display" class="text-sm">åŠ è½½ä¸­...</span>
                     <div class="bg-blue-100 h-6 w-6 rounded-full flex items-center justify-center">
                        <i class="far fa-calendar-alt text-xs"></i>
                     </div>
                 </button>
            </div>

            <div class="hero-card-bg rounded-[2rem] p-8 text-center relative overflow-hidden">
                <div class="absolute -top-10 -right-10 w-40 h-40 bg-blue-100 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-pulse"></div>
                 <div class="absolute -bottom-10 -left-10 w-40 h-40 bg-indigo-100 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-pulse" style="animation-delay: 1s;"></div>
                
                <div class="relative z-10">
                    <p class="text-gray-500 font-medium mb-2 flex items-center justify-center gap-2">
                        <i class="fas fa-wallet text-blue-500"></i> æœ¬æœˆç»“ä½™ (å‚¨è“„)
                    </p>
                    <p class="text-5xl font-black text-blue-600 tracking-tighter" id="cash-flow-display">Â¥0.00</p>
                </div>
            </div>
        </div>
        <div class="px-5 space-y-6 mt-2">
            <section>
                <h2 class="text-lg font-semibold mb-3 text-gray-700 ml-2 flex items-center gap-2"><i class="fas fa-chart-pie text-blue-500 text-sm"></i> æ”¶æ”¯åˆ†æ</h2>
                <div class="glass-card rounded-3xl p-5">
                    <div class="flex justify-between mb-6 bg-gray-50/80 p-2 rounded-2xl">
                        <div class="text-center w-1/2 border-r border-gray-200 active:bg-white rounded-l-xl py-2 transition-colors" onclick="showHistory('income')">
                            <p class="text-xs text-gray-500 mb-1">æ€»æ”¶å…¥ <i class="fas fa-chevron-right text-[8px] opacity-50"></i></p>
                            <p class="text-xl font-bold text-green-500" id="total-income">Â¥0</p>
                        </div>
                        <div class="text-center w-1/2 active:bg-white rounded-r-xl py-2 transition-colors" onclick="showHistory('expense')">
                            <p class="text-xs text-gray-500 mb-1">æ€»æ”¯å‡º <i class="fas fa-chevron-right text-[8px] opacity-50"></i></p>
                            <p class="text-xl font-bold text-red-500" id="total-expense">Â¥0</p>
                        </div>
                    </div>
                    <div class="h-48 w-full relative"><canvas id="expenseChart"></canvas></div>
                    <button onclick="openModal('transaction')" class="w-full mt-6 bg-gray-900 text-white py-4 rounded-2xl font-bold text-lg shadow-lg shadow-gray-200 active:scale-[0.98] transition-transform flex items-center justify-center gap-2">
                        <i class="fas fa-plus-circle"></i> <span id="add-btn-text">è®°ä¸€ç¬”</span>
                    </button>
                </div>
            </section>

            <section>
                <h2 class="text-lg font-semibold mb-3 text-gray-700 ml-2 flex items-center gap-2"><i class="fas fa-landmark text-blue-500 text-sm"></i> èµ„äº§æ¦‚è§ˆ</h2>
                <div class="glass-card rounded-3xl p-6 space-y-5">
                    <div onclick="showHistory('asset')" class="active:bg-gray-50/50 -m-2 p-3 rounded-2xl transition-colors">
                        <div class="flex justify-between text-sm mb-2">
                            <span class="font-medium text-gray-600">æ€»èµ„äº§</span>
                            <span class="text-blue-600 font-bold text-lg" id="total-assets">Â¥0</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-2"><div class="bg-blue-500 h-2 rounded-full shadow-sm shadow-blue-200" style="width: 100%"></div></div>
                    </div>
                    <div onclick="showHistory('liability')" class="active:bg-gray-50/50 -m-2 p-3 rounded-2xl transition-colors">
                        <div class="flex justify-between text-sm mb-2">
                            <span class="font-medium text-gray-600">æ€»è´Ÿå€º</span>
                            <span class="text-red-500 font-bold text-lg" id="total-liabilities">Â¥0</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-2"><div id="liability-bar" class="bg-red-500 h-2 rounded-full shadow-sm shadow-red-200" style="width: 0%"></div></div>
                    </div>
                    <div class="pt-5 border-t border-dashed border-gray-200 flex justify-between items-end">
                        <span class="text-sm text-gray-500 font-medium">å½“å‰å‡€èµ„äº§</span>
                        <span class="text-2xl font-black text-gray-900 tracking-tight" id="net-worth">Â¥0</span>
                    </div>
                     <button onclick="openModal('asset_input')" class="w-full mt-4 bg-blue-50 text-blue-600 py-3 rounded-2xl font-bold text-sm active:scale-[0.98] transition-transform">
                        ç®¡ç†èµ„äº§/è´Ÿå€ºé¡¹ç›®
                    </button>
                </div>
            </section>

            <section class="pb-8">
                <div class="glass-card rounded-3xl p-4 flex gap-4 text-center">
                    <button onclick="exportData()" class="flex-1 bg-blue-50 py-3 rounded-2xl text-blue-600 text-sm font-bold active:scale-95 transition-transform"><i class="fas fa-download mb-1 block text-lg opacity-70"></i>å¤‡ä»½æ•°æ®</button>
                    <button onclick="document.getElementById('importFile').click()" class="flex-1 bg-gray-50 py-3 rounded-2xl text-gray-600 text-sm font-bold active:scale-95 transition-transform"><i class="fas fa-upload mb-1 block text-lg opacity-70"></i>æ¢å¤æ•°æ®</button>
                    <input type="file" id="importFile" style="display:none" onchange="importData(this)">
                </div>
            </section>
        </div>
    </div>

    <div id="modal-history" class="fixed inset-0 bg-black/40 z-[60] hidden flex items-end backdrop-blur-sm transition-all">
        <div class="bg-[#F5F7FA] w-full rounded-t-[2.5rem] shadow-2xl animate-slide-up flex flex-col" style="height: 85vh;">
            <div class="p-6 border-b flex justify-between items-center bg-white/80 backdrop-blur-md rounded-t-[2.5rem]">
                <h3 class="text-xl font-extrabold text-gray-900" id="history-title">æ˜ç»†è®°å½•</h3>
                <button onclick="closeModal('history')" class="bg-gray-100 h-9 w-9 rounded-full flex items-center justify-center active:bg-gray-200 transition-colors"><i class="fas fa-times text-gray-400"></i></button>
            </div>
            <div id="history-list" class="flex-1 overflow-y-auto p-5 space-y-3">
                </div>
        </div>
    </div>

    <div id="modal-transaction" class="fixed inset-0 bg-black/40 z-50 hidden flex items-end backdrop-blur-sm transition-all">
        <div class="bg-white w-full rounded-t-[2.5rem] p-7 animate-slide-up shadow-[0_-10px_40px_rgba(0,0,0,0.1)]">
            <div class="flex justify-between items-center mb-8"><h3 class="text-2xl font-extrabold text-gray-900">è®°ä¸€ç¬”</h3><button onclick="closeModal('transaction')" class="bg-gray-50 h-10 w-10 rounded-full flex items-center justify-center active:bg-gray-100"><i class="fas fa-times text-gray-400 text-lg"></i></button></div>
            <div class="space-y-6">
                <div class="flex bg-gray-100 p-1.5 rounded-2xl">
                    <button onclick="setTransType('expense')" id="btn-expense" class="flex-1 py-3 rounded-xl text-sm font-bold bg-white shadow-sm transition-all">æ”¯å‡º</button>
                    <button onclick="setTransType('income')" id="btn-income" class="flex-1 py-3 rounded-xl text-sm font-bold text-gray-500 transition-all">æ”¶å…¥</button>
                </div>
                <div class="relative">
                    <span class="absolute left-0 top-1/2 -translate-y-1/2 text-3xl font-bold text-gray-400">Â¥</span>
                    <input type="number" id="t-amount" class="w-full pl-10 text-4xl font-black border-b-2 border-gray-100 py-4 outline-none focus:border-blue-500 transition-colors bg-transparent" placeholder="0.00">
                </div>
                <select id="t-category" class="w-full bg-gray-50 rounded-2xl px-5 py-4 outline-none text-lg font-medium appearance-none border border-gray-100 focus:border-blue-300 transition-all">
                    <option value="é¤é¥®">ğŸ” é¤é¥®ç¾é£Ÿ</option><option value="äº¤é€š">ğŸš— äº¤é€šå‡ºè¡Œ</option><option value="è´­ç‰©">ğŸ›ï¸ è´­ç‰©æ¶ˆè´¹</option><option value="å±…ä½">ğŸ  å±…ä½ç¼´è´¹</option><option value="å·¥èµ„">ğŸ’° å·¥èµ„æ”¶å…¥</option><option value="å…¶ä»–">ğŸ“ å…¶ä»–</option>
                </select>
                <button onclick="saveRecord('transaction')" class="w-full bg-gray-900 text-white py-4 rounded-[1.2rem] font-bold text-lg active:scale-[0.98] transition-transform shadow-lg shadow-gray-200">ä¿å­˜è®°å½•</button>
            </div>
        </div>
    </div>

    <div id="modal-asset_input" class="fixed inset-0 bg-black/40 z-50 hidden flex items-end backdrop-blur-sm transition-all">
        <div class="bg-white w-full rounded-t-[2.5rem] p-7 animate-slide-up shadow-[0_-10px_40px_rgba(0,0,0,0.1)]">
            <div class="flex justify-between items-center mb-8"><h3 class="text-2xl font-extrabold text-gray-900">æ–°å¢èµ„äº§/è´Ÿå€º</h3><button onclick="closeModal('asset_input')" class="bg-gray-50 h-10 w-10 rounded-full flex items-center justify-center active:bg-gray-100"><i class="fas fa-times text-gray-400 text-lg"></i></button></div>
            <div class="space-y-6">
                <div class="flex bg-gray-100 p-1.5 rounded-2xl">
                    <button onclick="setAssetType('asset')" id="btn-asset" class="flex-1 py-3 rounded-xl text-sm font-bold bg-white shadow-sm text-blue-600 transition-all">èµ„äº§ (å­˜é’±)</button>
                    <button onclick="setAssetType('liability')" id="btn-liability" class="flex-1 py-3 rounded-xl text-sm font-bold text-gray-500 transition-all">è´Ÿå€º (å€Ÿé’±)</button>
                </div>
                <input type="text" id="a-name" class="w-full bg-gray-50 rounded-2xl px-5 py-4 outline-none text-lg font-medium border border-gray-100 focus:border-blue-300 transition-all" placeholder="é¡¹ç›®åç§° (ä¾‹: æ‹›è¡Œå¡, èŠ±å‘—)">
                <div class="relative">
                     <span class="absolute left-0 top-1/2 -translate-y-1/2 text-3xl font-bold text-gray-400">Â¥</span>
                    <input type="number" id="a-amount" class="w-full pl-10 text-4xl font-black border-b-2 border-gray-100 py-4 outline-none focus:border-blue-500 transition-colors bg-transparent" placeholder="0.00">
                </div>
                <button onclick="saveRecord('asset')" class="w-full bg-blue-600 text-white py-4 rounded-[1.2rem] font-bold text-lg active:scale-[0.98] transition-transform shadow-lg shadow-blue-200">ä¿å­˜é¡¹ç›®</button>
            </div>
        </div>
    </div>

    <script>
        // =================================================================
        //  JavaScript é€»è¾‘éƒ¨åˆ† (å®Œå…¨ä¿æŒä¸å˜ï¼Œé€‚é…äº†æ–°çš„ UI ID)
        // =================================================================
        let financeData = { records: [] };
        let viewDate = new Date(); 
        let currentTransType = 'expense';
        let currentAssetType = 'asset';
        let expenseChartInstance = null;

        window.onload = function() {
            const savedData = localStorage.getItem('myFinanceData_v2');
            if (savedData) financeData = JSON.parse(savedData);
            const year = viewDate.getFullYear();
            const month = (viewDate.getMonth() + 1).toString().padStart(2, '0');
            document.getElementById('date-picker-input').value = `${year}-${month}`;
            updateUI();
        };

        function openDatePicker() {
            try { document.getElementById('date-picker-input').showPicker(); } catch (e) { document.getElementById('date-picker-input').click(); }
        }

        function handleDateChange(input) {
            if(input.value) {
                const parts = input.value.split('-');
                viewDate = new Date(parts[0], parts[1] - 1, 1);
                updateUI();
            }
        }

        function updateUI() {
            let totals = { income: 0, expense: 0, asset: 0, liability: 0 };
            let catExp = {};
            const vYear = viewDate.getFullYear();
            const vMonth = viewDate.getMonth();

            // æ›´æ–°é¡¶éƒ¨æ˜¾ç¤ºçš„æ—¥æœŸ (æ³¨æ„ ID å˜åŒ–ï¼šcurrent-date-display)
            document.getElementById('current-date-display').innerText = `${vYear}å¹´${vMonth + 1}æœˆ`;

            const today = new Date();
            if (vYear === today.getFullYear() && vMonth === today.getMonth()) {
                document.getElementById('add-btn-text').innerText = "è®°ä¸€ç¬”";
            } else {
                document.getElementById('add-btn-text').innerText = `è¡¥å½• (${vMonth+1}æœˆ)`;
            }

            financeData.records.forEach(r => {
                const rDate = new Date(r.date);
                if (r.type === 'income' || r.type === 'expense') {
                    if (rDate.getFullYear() === vYear && rDate.getMonth() === vMonth) {
                        totals[r.type] += parseFloat(r.amount);
                        if (r.type === 'expense') {
                            catExp[r.category] = (catExp[r.category] || 0) + parseFloat(r.amount);
                        }
                    }
                } else {
                    totals[r.type] += parseFloat(r.amount);
                }
            });

            document.getElementById('total-income').innerText = `Â¥${totals.income.toFixed(2)}`;
            document.getElementById('total-expense').innerText = `Â¥${totals.expense.toFixed(2)}`;
            document.getElementById('total-assets').innerText = `Â¥${totals.asset.toFixed(0)}`;
            document.getElementById('total-liabilities').innerText = `Â¥${totals.liability.toFixed(0)}`;
            
            const cashFlow = totals.income - totals.expense;
            const flowEl = document.getElementById('cash-flow-display');
            flowEl.innerText = `Â¥${cashFlow.toFixed(2)}`;
            // æ›´æ–°äº†é¢œè‰²ç±»åä»¥åŒ¹é…æ–°é£æ ¼
            flowEl.className = `text-5xl font-black tracking-tighter ${cashFlow >= 0 ? 'text-blue-600' : 'text-red-500'}`;

            const netWorth = totals.asset - totals.liability;
            document.getElementById('net-worth').innerText = `Â¥${netWorth.toFixed(0)}`;
            
            const maxVal = Math.max(totals.asset, totals.liability, 1);
            document.getElementById('liability-bar').style.width = `${(totals.liability / maxVal) * 100}%`;

            updateChart(catExp);
            localStorage.setItem('myFinanceData_v2', JSON.stringify(financeData));
        }

        function updateChart(data) {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            if (expenseChartInstance) expenseChartInstance.destroy();
            const displayData = Object.keys(data).length === 0 ? { "æ— æ”¯å‡º": 1 } : data;
            // æ›´æ–°äº†å›¾è¡¨é…è‰²ï¼Œæ›´æ¸…æ–°
            const displayColors = Object.keys(data).length === 0 ? ['#E5E7EB'] : ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#6366F1'];

            expenseChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(displayData),
                    datasets: [{ data: Object.values(displayData), backgroundColor: displayColors, borderWidth: 0 }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { position: 'right', labels: { boxWidth: 8, usePointStyle: true, font: { size: 11 } } },
                        tooltip: { enabled: Object.keys(data).length !== 0 }
                    }, 
                    cutout: '75%',
                    layout: { padding: { left: 0, right: 0, top: 10, bottom: 10 } }
                }
            });
        }

        function showHistory(type) {
            const titles = { income: 'æ”¶å…¥æ˜ç»†', expense: 'æ”¯å‡ºæ˜ç»†', asset: 'èµ„äº§æ˜ç»†', liability: 'è´Ÿå€ºæ˜ç»†' };
            const vYear = viewDate.getFullYear();
            const vMonth = viewDate.getMonth();
            const monthLabel = `${vYear}å¹´${vMonth+1}æœˆ`;

            document.getElementById('history-title').innerText = `${titles[type]} (${type==='asset'||type==='liability'?'å…¨éƒ¨':monthLabel})`;
            const listEl = document.getElementById('history-list');
            listEl.innerHTML = '';

            const filtered = financeData.records.filter(r => {
                if (r.type !== type) return false;
                if (type === 'income' || type === 'expense') {
                    const rDate = new Date(r.date);
                    return rDate.getFullYear() === vYear && rDate.getMonth() === vMonth;
                }
                return true;
            });

            if (filtered.length === 0) {
                listEl.innerHTML = '<div class="text-center text-gray-400 mt-10 flex flex-col items-center"><i class="fas fa-inbox text-4xl mb-3 opacity-30"></i><p>æœ¬æœˆæš‚æ— è®°å½•</p></div>';
            } else {
                filtered.reverse().forEach(r => {
                    const div = document.createElement('div');
                    // æ›´æ–°äº†åˆ—è¡¨é¡¹æ ·å¼
                    div.className = "bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm border border-gray-50";
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="h-10 w-10 rounded-full bg-gray-50 flex items-center justify-center text-lg">
                                ${getIconForCategory(r.category)}
                            </div>
                            <div>
                                <p class="font-bold text-gray-800">${r.category || r.name}</p>
                                <p class="text-[11px] text-gray-400 font-medium">${r.date.split('T')[0]}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-bold text-lg ${r.type==='income'||r.type==='asset'?'text-green-500':'text-red-500'}">${r.type==='income'||r.type==='asset'?'+':'-'}Â¥${parseFloat(r.amount).toFixed(2)}</span>
                            <button onclick="deleteRecord('${r.id}', '${type}')" class="text-gray-300 active:text-red-500 p-2"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;
                    listEl.appendChild(div);
                });
            }
            openModal('history');
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šä¸ºåˆ—è¡¨æ·»åŠ ç®€å•å›¾æ ‡
        function getIconForCategory(cat) {
            if(!cat) return '<i class="fas fa-coins text-blue-400"></i>';
            if(cat.includes('é¤é¥®')) return 'ğŸ”';
            if(cat.includes('äº¤é€š')) return 'ğŸš—';
            if(cat.includes('è´­ç‰©')) return 'ğŸ›ï¸';
            if(cat.includes('å±…ä½')) return 'ğŸ ';
            if(cat.includes('å·¥èµ„')) return 'ğŸ’°';
            return 'ğŸ“';
        }

        function deleteRecord(id, type) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
                financeData.records = financeData.records.filter(r => r.id !== id);
                updateUI();
                showHistory(type); 
            }
        }

        function saveRecord(mode) {
            let recordDate = new Date();
            if (recordDate.getMonth() !== viewDate.getMonth() || recordDate.getFullYear() !== viewDate.getFullYear()) {
                recordDate = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1, 12, 0, 0);
            }
            let record = { id: Date.now().toString(), date: recordDate.toISOString() };
            
            if (mode === 'transaction') {
                const amt = document.getElementById('t-amount').value;
                if (!amt) return alert('è¯·è¾“å…¥é‡‘é¢');
                record.type = currentTransType;
                record.amount = amt;
                record.category = document.getElementById('t-category').value;
                document.getElementById('t-amount').value = '';
                closeModal('transaction');
            } else {
                const amt = document.getElementById('a-amount').value;
                const name = document.getElementById('a-name').value;
                if (!amt || !name) return alert('è¯·è¾“å…¥å®Œæ•´ä¿¡æ¯');
                record.type = currentAssetType;
                record.amount = amt;
                record.name = name;
                document.getElementById('a-amount').value = '';
                document.getElementById('a-name').value = '';
                closeModal('asset_input');
            }
            financeData.records.push(record);
            updateUI();
        }

        function openModal(t) { document.getElementById(`modal-${t}`).classList.remove('hidden'); }
        function closeModal(t) { document.getElementById(`modal-${t}`).classList.add('hidden'); }

        // æ›´æ–°äº†å¼¹çª—æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€æ ·å¼
        function setTransType(t) {
            currentTransType = t;
            document.getElementById('btn-expense').className = t==='expense'?'flex-1 py-3 rounded-xl text-sm font-bold bg-white shadow-sm text-red-500 transition-all':'flex-1 py-3 rounded-xl text-sm font-bold text-gray-500 transition-all';
            document.getElementById('btn-income').className = t==='income'?'flex-1 py-3 rounded-xl text-sm font-bold bg-white shadow-sm text-green-500 transition-all':'flex-1 py-3 rounded-xl text-sm font-bold text-gray-500 transition-all';
        }

        function setAssetType(t) {
            currentAssetType = t;
            document.getElementById('btn-asset').className = t==='asset'?'flex-1 py-3 rounded-xl text-sm font-bold bg-white shadow-sm text-blue-600 transition-all':'flex-1 py-3 rounded-xl text-sm font-bold text-gray-500 transition-all';
            document.getElementById('btn-liability').className = t==='liability'?'flex-1 py-3 rounded-xl text-sm font-bold bg-white shadow-sm text-red-500 transition-all':'flex-1 py-3 rounded-xl text-sm font-bold text-gray-500 transition-all';
        }

        function exportData() {
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(JSON.stringify(financeData));
            const a = document.createElement('a');
            a.setAttribute('href', dataUri);
            a.setAttribute('download', `è´¢åŠ¡å¤‡ä»½_${new Date().toLocaleDateString()}.json`);
            a.click();
        }

        function importData(input) {
            const reader = new FileReader();
            reader.onload = e => {
                financeData = JSON.parse(e.target.result);
                updateUI();
                alert('æ¢å¤æˆåŠŸ');
            };
            reader.readAsText(input.files[0]);
        }
    </script>
</body>
</html>        <section>
            <h2 class="text-lg font-semibold mb-3 text-gray-700 ml-1">ç°é‡‘æµ (æœ¬æœˆå‚¨è“„)</h2>
            <div class="glass-card rounded-2xl p-6 flex justify-between items-center">
                <div>
                    <p class="text-sm text-gray-500">æœ¬æœˆç»“ä½™</p>
                    <p class="text-3xl font-bold text-blue-600 mt-1" id="cash-flow-display">Â¥0.00</p>
                </div>
                <div class="h-12 w-12 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
                    <i class="fas fa-wallet text-xl"></i>
                </div>
            </div>
        </section>

        <section>
            <h2 class="text-lg font-semibold mb-3 text-gray-700 ml-1">æ”¶æ”¯è¡¨ (ç‚¹å‡»é‡‘é¢çœ‹æ˜ç»†)</h2>
            <div class="glass-card rounded-2xl p-5">
                <div class="flex justify-between mb-4">
                    <div class="text-center w-1/2 border-r border-gray-200 active:bg-gray-50 rounded-l-xl" onclick="showHistory('income')">
                        <p class="text-xs text-gray-500">æ€»æ”¶å…¥ <i class="fas fa-chevron-right text-[8px]"></i></p>
                        <p class="text-lg font-bold text-green-500" id="total-income">Â¥0</p>
                    </div>
                    <div class="text-center w-1/2 active:bg-gray-50 rounded-r-xl" onclick="showHistory('expense')">
                        <p class="text-xs text-gray-500">æ€»æ”¯å‡º <i class="fas fa-chevron-right text-[8px]"></i></p>
                        <p class="text-lg font-bold text-red-500" id="total-expense">Â¥0</p>
                    </div>
                </div>
                <div class="h-44 w-full relative"><canvas id="expenseChart"></canvas></div>
                <button onclick="openModal('transaction')" class="w-full mt-4 bg-black text-white py-3 rounded-xl font-medium active:scale-95 transition-transform">
                    <i class="fas fa-plus mr-2"></i> è®°ä¸€ç¬”
                </button>
            </div>
        </section>

        <section>
            <h2 class="text-lg font-semibold mb-3 text-gray-700 ml-1">èµ„äº§è´Ÿå€º (ç‚¹å‡»é‡‘é¢çœ‹æ˜ç»†)</h2>
            <div class="glass-card rounded-2xl p-5 space-y-4">
                <div onclick="showHistory('asset')" class="active:bg-gray-50 p-1 rounded-lg">
                    <div class="flex justify-between text-sm mb-1">
                        <span class="font-medium">æ€»èµ„äº§ <i class="fas fa-chevron-right text-[8px]"></i></span>
                        <span class="text-blue-600 font-bold" id="total-assets">Â¥0</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-blue-500 h-2.5 rounded-full" style="width: 100%"></div></div>
                </div>
                <div onclick="showHistory('liability')" class="active:bg-gray-50 p-1 rounded-lg">
                    <div class="flex justify-between text-sm mb-1">
                        <span class="font-medium">æ€»è´Ÿå€º <i class="fas fa-chevron-right text-[8px]"></i></span>
                        <span class="text-red-500 font-bold" id="total-liabilities">Â¥0</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5"><div id="liability-bar" class="bg-red-500 h-2.5 rounded-full" style="width: 0%"></div></div>
                </div>
                <div class="pt-3 border-t border-gray-100 flex justify-between items-center">
                    <span class="text-sm text-gray-500">å‡€èµ„äº§</span>
                    <span class="text-xl font-bold text-gray-900" id="net-worth">Â¥0</span>
                </div>
                 <button onclick="openModal('asset_input')" class="w-full mt-2 bg-gray-100 text-gray-800 py-3 rounded-xl font-medium active:scale-95 transition-transform">
                    <i class="fas fa-edit mr-2"></i> æ–°å¢èµ„äº§/è´Ÿå€ºé¡¹ç›®
                </button>
            </div>
        </section>

        <section class="pb-10">
            <div class="glass-card rounded-2xl p-4 flex gap-3 text-center">
                <button onclick="exportData()" class="flex-1 text-blue-600 text-sm font-medium"><i class="fas fa-download mb-1 block text-lg"></i>å¤‡ä»½</button>
                <button onclick="document.getElementById('importFile').click()" class="flex-1 text-gray-600 text-sm font-medium"><i class="fas fa-upload mb-1 block text-lg"></i>æ¢å¤</button>
                <input type="file" id="importFile" style="display:none" onchange="importData(this)">
            </div>
        </section>
    </div>

    <div id="modal-history" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-end backdrop-blur-sm">
        <div class="bg-[#F2F2F7] w-full rounded-t-3xl shadow-2xl animate-slide-up flex flex-col" style="height: 80vh;">
            <div class="p-5 border-b flex justify-between items-center bg-white rounded-t-3xl">
                <h3 class="text-xl font-bold" id="history-title">æ˜ç»†è®°å½•</h3>
                <button onclick="closeModal('history')" class="bg-gray-100 h-8 w-8 rounded-full flex items-center justify-center"><i class="fas fa-times text-gray-400"></i></button>
            </div>
            <div id="history-list" class="flex-1 overflow-y-auto p-5 space-y-3">
                </div>
        </div>
    </div>

    <div id="modal-transaction" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-end backdrop-blur-sm">
        <div class="bg-white w-full rounded-t-3xl p-6 animate-slide-up">
            <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold">è®°ä¸€ç¬”</h3><button onclick="closeModal('transaction')"><i class="fas fa-times text-gray-400 text-xl"></i></button></div>
            <div class="space-y-4">
                <div class="flex bg-gray-100 p-1 rounded-xl">
                    <button onclick="setTransType('expense')" id="btn-expense" class="flex-1 py-2 rounded-lg text-sm font-medium bg-white shadow-sm">æ”¯å‡º</button>
                    <button onclick="setTransType('income')" id="btn-income" class="flex-1 py-2 rounded-lg text-sm font-medium text-gray-500">æ”¶å…¥</button>
                </div>
                <input type="number" id="t-amount" class="w-full text-3xl font-bold border-b py-2 outline-none" placeholder="0.00">
                <select id="t-category" class="w-full bg-gray-50 rounded-xl px-4 py-3 outline-none">
                    <option value="é¤é¥®">ğŸ” é¤é¥®ç¾é£Ÿ</option><option value="äº¤é€š">ğŸš— äº¤é€šå‡ºè¡Œ</option><option value="è´­ç‰©">ğŸ›ï¸ è´­ç‰©æ¶ˆè´¹</option><option value="å±…ä½">ğŸ  å±…ä½ç¼´è´¹</option><option value="å·¥èµ„">ğŸ’° å·¥èµ„æ”¶å…¥</option><option value="å…¶ä»–">ğŸ“ å…¶ä»–</option>
                </select>
                <button onclick="saveRecord('transaction')" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold text-lg">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div id="modal-asset_input" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-end backdrop-blur-sm">
        <div class="bg-white w-full rounded-t-3xl p-6 animate-slide-up">
            <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold">æ–°å¢èµ„äº§/è´Ÿå€º</h3><button onclick="closeModal('asset_input')"><i class="fas fa-times text-gray-400 text-xl"></i></button></div>
            <div class="space-y-4">
                <div class="flex bg-gray-100 p-1 rounded-xl">
                    <button onclick="setAssetType('asset')" id="btn-asset" class="flex-1 py-2 rounded-lg text-sm font-medium bg-white shadow-sm">èµ„äº§</button>
                    <button onclick="setAssetType('liability')" id="btn-liability" class="flex-1 py-2 rounded-lg text-sm font-medium text-gray-500">è´Ÿå€º</button>
                </div>
                <input type="text" id="a-name" class="w-full bg-gray-50 rounded-xl px-4 py-3 outline-none" placeholder="ä¾‹å¦‚ï¼šæ‹›è¡Œå­˜æ¬¾ã€ä¿¡ç”¨å¡">
                <input type="number" id="a-amount" class="w-full text-3xl font-bold border-b py-2 outline-none" placeholder="0.00">
                <button onclick="saveRecord('asset')" class="w-full bg-black text-white py-4 rounded-2xl font-bold text-lg">ä¿å­˜é¡¹ç›®</button>
            </div>
        </div>
    </div>

    <script>
        // æ•°æ®ç»“æ„ï¼šç»Ÿä¸€å­˜å‚¨æ‰€æœ‰è®°å½•
        let financeData = {
            records: [] // {id, type, amount, category, name, date}
        };

        let currentTransType = 'expense';
        let currentAssetType = 'asset';
        let expenseChartInstance = null;

        window.onload = function() {
            const date = new Date();
            document.getElementById('current-date').innerText = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ`;
            const savedData = localStorage.getItem('myFinanceData_v2');
            if (savedData) financeData = JSON.parse(savedData);
            updateUI();
        };

        function updateUI() {
            let totals = { income: 0, expense: 0, asset: 0, liability: 0 };
            let catExp = {};

            financeData.records.forEach(r => {
                totals[r.type] += parseFloat(r.amount);
                if (r.type === 'expense') {
                    catExp[r.category] = (catExp[r.category] || 0) + parseFloat(r.amount);
                }
            });

            document.getElementById('total-income').innerText = `Â¥${totals.income.toFixed(2)}`;
            document.getElementById('total-expense').innerText = `Â¥${totals.expense.toFixed(2)}`;
            document.getElementById('total-assets').innerText = `Â¥${totals.asset.toFixed(0)}`;
            document.getElementById('total-liabilities').innerText = `Â¥${totals.liability.toFixed(0)}`;
            
            const cashFlow = totals.income - totals.expense;
            const flowEl = document.getElementById('cash-flow-display');
            flowEl.innerText = `Â¥${cashFlow.toFixed(2)}`;
            flowEl.className = `text-3xl font-bold mt-1 ${cashFlow >= 0 ? 'text-blue-600' : 'text-red-500'}`;

            const netWorth = totals.asset - totals.liability;
            document.getElementById('net-worth').innerText = `Â¥${netWorth.toFixed(0)}`;
            
            const maxVal = Math.max(totals.asset, totals.liability, 1);
            document.getElementById('liability-bar').style.width = `${(totals.liability / maxVal) * 100}%`;

            updateChart(catExp);
            localStorage.setItem('myFinanceData_v2', JSON.stringify(financeData));
        }

        function updateChart(data) {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            if (expenseChartInstance) expenseChartInstance.destroy();
            if (Object.keys(data).length === 0) return;
            expenseChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data),
                    datasets: [{ data: Object.values(data), backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } }, cutout: '70%' }
            });
        }

        // --- æ ¸å¿ƒé€»è¾‘ï¼šæŸ¥çœ‹æ˜ç»†ä¸åˆ é™¤ ---
        function showHistory(type) {
            const titles = { income: 'æ”¶å…¥æ˜ç»†', expense: 'æ”¯å‡ºæ˜ç»†', asset: 'èµ„äº§æ˜ç»†', liability: 'è´Ÿå€ºæ˜ç»†' };
            document.getElementById('history-title').innerText = titles[type];
            const listEl = document.getElementById('history-list');
            listEl.innerHTML = '';

            const filtered = financeData.records.filter(r => r.type === type);

            if (filtered.length === 0) {
                listEl.innerHTML = '<p class="text-center text-gray-400 mt-10">æš‚æ— è®°å½•</p>';
            } else {
                filtered.reverse().forEach(r => {
                    const div = document.createElement('div');
                    div.className = "bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm";
                    div.innerHTML = `
                        <div>
                            <p class="font-bold text-gray-800">${r.category || r.name}</p>
                            <p class="text-[10px] text-gray-400">${r.date.split('T')[0]}</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="font-bold ${r.type==='income'||r.type==='asset'?'text-green-500':'text-red-500'}">Â¥${parseFloat(r.amount).toFixed(2)}</span>
                            <button onclick="deleteRecord('${r.id}', '${type}')" class="text-gray-300 active:text-red-500 px-2 py-1"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;
                    listEl.appendChild(div);
                });
            }
            openModal('history');
        }

        function deleteRecord(id, type) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
                financeData.records = financeData.records.filter(r => r.id !== id);
                updateUI();
                showHistory(type); // åˆ·æ–°å½“å‰åˆ—è¡¨
            }
        }

        // --- ä¿å­˜åŠŸèƒ½ ---
        function saveRecord(mode) {
            let record = { id: Date.now().toString(), date: new Date().toISOString() };
            if (mode === 'transaction') {
                const amt = document.getElementById('t-amount').value;
                if (!amt) return alert('è¯·è¾“å…¥é‡‘é¢');
                record.type = currentTransType;
                record.amount = amt;
                record.category = document.getElementById('t-category').value;
                document.getElementById('t-amount').value = '';
                closeModal('transaction');
            } else {
                const amt = document.getElementById('a-amount').value;
                const name = document.getElementById('a-name').value;
                if (!amt || !name) return alert('è¯·è¾“å…¥å®Œæ•´ä¿¡æ¯');
                record.type = currentAssetType;
                record.amount = amt;
                record.name = name;
                document.getElementById('a-amount').value = '';
                document.getElementById('a-name').value = '';
                closeModal('asset_input');
            }
            financeData.records.push(record);
            updateUI();
        }

        // --- å¼¹çª—é€»è¾‘ ---
        function openModal(t) { document.getElementById(`modal-${t}`).classList.remove('hidden'); }
        function closeModal(t) { document.getElementById(`modal-${t}`).classList.add('hidden'); }

        function setTransType(t) {
            currentTransType = t;
            document.getElementById('btn-expense').className = t==='expense'?'flex-1 py-2 rounded-lg text-sm font-medium bg-white shadow-sm':'flex-1 py-2 rounded-lg text-sm font-medium text-gray-500';
            document.getElementById('btn-income').className = t==='income'?'flex-1 py-2 rounded-lg text-sm font-medium bg-white shadow-sm':'flex-1 py-2 rounded-lg text-sm font-medium text-gray-500';
        }

        function setAssetType(t) {
            currentAssetType = t;
            document.getElementById('btn-asset').className = t==='asset'?'flex-1 py-2 rounded-lg text-sm font-medium bg-white shadow-sm':'flex-1 py-2 rounded-lg text-sm font-medium text-gray-500';
            document.getElementById('btn-liability').className = t==='liability'?'flex-1 py-2 rounded-lg text-sm font-medium bg-white shadow-sm':'flex-1 py-2 rounded-lg text-sm font-medium text-gray-500';
        }

        // --- å¯¼å…¥å¯¼å‡º ---
        function exportData() {
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(JSON.stringify(financeData));
            const a = document.createElement('a');
            a.setAttribute('href', dataUri);
            a.setAttribute('download', `è´¢åŠ¡å¤‡ä»½_${new Date().toLocaleDateString()}.json`);
            a.click();
        }

        function importData(input) {
            const reader = new FileReader();
            reader.onload = e => {
                financeData = JSON.parse(e.target.result);
                updateUI();
                alert('æ¢å¤æˆåŠŸ');
            };
            reader.readAsText(input.files[0]);
        }
    </script>
</body>

</html>
